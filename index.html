<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crimson Desert â€” PS Store Global Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.0.1/chartjs-plugin-annotation.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <style>
    :root {
      --bg: #0a0608;
      --surface: #110d0f;
      --surface2: #1a1318;
      --border: #2a1f22;
      --red: #c0392b;
      --red-glow: #e74c3c;
      --gold: #d4a017;
      --text: #e8ddd5;
      --muted: #7a6a65;
      --up: #2ecc71;
      --down: #e74c3c;
      --same: #5a5a5a;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ë°°ê²½ í…ìŠ¤ì²˜ */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse 80% 40% at 50% -10%, rgba(192,57,43,0.12) 0%, transparent 70%),
        url("data:image/svg+xml,%3Csvg width='60' height='60' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 0;
    }

    .container { position: relative; z-index: 1; max-width: 1400px; margin: 0 auto; padding: 0 24px 60px; }

    /* â”€â”€â”€ HEADER â”€â”€â”€ */
    header {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 48px 24px 32px;
      border-bottom: 1px solid var(--border);
      position: relative;
    }

    .logo-line {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 4px;
    }

    .logo-icon {
      width: 44px;
      height: 44px;
      background: var(--red);
      clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
      animation: pulse-icon 3s ease-in-out infinite;
    }

    @keyframes pulse-icon {
      0%, 100% { box-shadow: 0 0 0 0 rgba(192,57,43,0.4); }
      50% { box-shadow: 0 0 20px 6px rgba(192,57,43,0.2); }
    }

    h1 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: clamp(2rem, 5vw, 3.5rem);
      letter-spacing: 4px;
      color: var(--text);
      line-height: 1;
    }

    h1 span { color: var(--red-glow); }

    .subtitle {
      font-size: 0.75rem;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--muted);
      margin-top: 6px;
    }

    .meta-row {
      display: flex;
      gap: 24px;
      margin-top: 16px;
      font-size: 0.78rem;
      color: var(--muted);
      flex-wrap: wrap;
      justify-content: center;
    }

    .meta-row strong { color: var(--text); }

    /* â”€â”€â”€ HERO STATS â”€â”€â”€ */
    .hero-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1px;
      margin: 32px 0;
      border: 1px solid var(--border);
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
    }

    .stat-box {
      background: var(--surface);
      padding: 24px 20px;
      text-align: center;
      transition: background 0.2s;
    }

    .stat-box:hover { background: var(--surface2); }

    .stat-label {
      font-size: 0.65rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .stat-value {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 2.4rem;
      line-height: 1;
      color: var(--red-glow);
    }

    .stat-value.gold { color: var(--gold); }
    .stat-value.neutral { color: var(--text); }

    .stat-diff {
      font-size: 0.75rem;
      margin-top: 4px;
      color: var(--muted);
    }

    .stat-diff.up { color: var(--up); }
    .stat-diff.down { color: var(--down); }

    /* â”€â”€â”€ COUNTDOWN â”€â”€â”€ */
    .countdown-section {
      margin-bottom: 32px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 24px;
      position: relative;
      overflow: hidden;
    }
    .countdown-section::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(ellipse 60% 80% at 50% 120%, rgba(192,57,43,0.08) 0%, transparent 70%);
      pointer-events: none;
    }
    .countdown-title {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.2rem;
      letter-spacing: 3px;
      color: var(--muted);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .countdown-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }
    .countdown-regions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
    }
    .countdown-card {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 3px;
      padding: 14px 16px;
      text-align: center;
    }
    .countdown-card.released { border-color: var(--up); }
    .countdown-card.released .countdown-flag { opacity: 0.6; }
    .countdown-flag { font-size: 1.6rem; line-height: 1; margin-bottom: 4px; }
    .countdown-country { font-size: 0.65rem; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); margin-bottom: 8px; }
    .countdown-digits { display: flex; justify-content: center; gap: 4px; margin-bottom: 6px; }
    .cd-unit { display: flex; flex-direction: column; align-items: center; }
    .cd-num { font-family: 'Bebas Neue', sans-serif; font-size: 1.6rem; line-height: 1; color: var(--red-glow); min-width: 28px; text-align: center; }
    .cd-sep { font-family: 'Bebas Neue', sans-serif; font-size: 1.4rem; color: var(--border); line-height: 1; padding-bottom: 10px; align-self: flex-end; }
    .cd-label { font-size: 0.52rem; letter-spacing: 1.5px; text-transform: uppercase; color: var(--muted); margin-top: 2px; }
    .countdown-localtime { font-size: 0.65rem; color: var(--muted); letter-spacing: 0.5px; }
    .countdown-released-badge { font-family: 'Bebas Neue', sans-serif; font-size: 1.3rem; letter-spacing: 2px; color: var(--up); margin: 6px 0; }
    @media (max-width: 640px) { .countdown-regions { grid-template-columns: repeat(2, 1fr); } }

    /* â”€â”€â”€ CHART â”€â”€â”€ */
    .chart-section {
      margin-bottom: 32px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 24px;
    }

    .section-title {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.2rem;
      letter-spacing: 3px;
      color: var(--muted);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    .chart-wrapper { position: relative; height: 220px; }

    /* â”€â”€â”€ EVENT TOGGLE â”€â”€â”€ */
    .event-toggle-wrap {
      margin-bottom: 10px;
    }
    .event-toggle-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      cursor: pointer;
      user-select: none;
    }
    .event-toggle-title {
      font-size: 0.68rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--muted);
    }
    .event-toggle-arrow {
      font-size: 0.7rem;
      color: var(--muted);
      transition: transform 0.2s;
    }
    .event-toggle-arrow.open { transform: rotate(180deg); }
    .event-toggle-panel {
      display: none;
      flex-wrap: wrap;
      gap: 5px;
      padding: 8px 0;
    }
    .event-toggle-panel.open { display: flex; }
    .ev-btn {
      font-size: 0.68rem;
      padding: 3px 8px;
      border-radius: 3px;
      border: 1px solid;
      cursor: pointer;
      background: transparent;
      opacity: 0.4;
      transition: opacity 0.15s;
      white-space: nowrap;
    }
    .ev-btn.active { opacity: 1; }



    /* â”€â”€â”€ REGION TABS â”€â”€â”€ */
    .tabs {
      display: flex;
      gap: 0;
      margin-bottom: 0;
      border: 1px solid var(--border);
      border-bottom: none;
      border-radius: 4px 4px 0 0;
      overflow: hidden;
    }

    .tab-btn {
      flex: 1;
      padding: 12px 8px;
      background: var(--surface);
      border: none;
      color: var(--muted);
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1rem;
      letter-spacing: 2px;
      cursor: pointer;
      transition: all 0.2s;
      border-right: 1px solid var(--border);
    }

    .tab-btn:last-child { border-right: none; }
    .tab-btn:hover { background: var(--surface2); color: var(--text); }
    .tab-btn.active { background: var(--red); color: #fff; }

    /* â”€â”€â”€ COUNTRY TABLE â”€â”€â”€ */
    .sortable {
      cursor: pointer;
      user-select: none;
    }
    .sortable:hover { color: var(--red-glow); }
    .sort-icon { font-size: 0.75rem; color: var(--muted); margin-left: 4px; }
    .sort-icon.asc { color: var(--gold); }
    .sort-icon.desc { color: var(--gold); }

    .table-wrap {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 0 0 4px 4px;
      overflow: hidden;
      margin-bottom: 32px;
    }

    table { width: 100%; border-collapse: collapse; }

    thead tr {
      background: var(--surface2);
      border-bottom: 1px solid var(--border);
    }

    th {
      padding: 10px 16px;
      font-size: 0.65rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--muted);
      text-align: left;
      font-weight: 400;
    }

    th:not(:first-child) { text-align: center; }

    tbody tr {
      border-bottom: 1px solid var(--border);
      transition: background 0.15s;
    }

    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: var(--surface2); }

    td {
      padding: 12px 16px;
      font-size: 0.85rem;
    }

    td:not(:first-child) { text-align: center; }

    .country-cell {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .flag { font-size: 1.2rem; }

    .country-name { font-weight: 700; }

    .weight-badge {
      font-size: 0.65rem;
      color: var(--muted);
      background: var(--surface2);
      padding: 2px 6px;
      border-radius: 2px;
    }

    .rank-val { font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; }

    .rank-val.no-data { color: var(--muted); font-size: 0.8rem; }

    .diff-badge {
      display: inline-flex;
      align-items: center;
      gap: 2px;
      font-size: 0.7rem;
      padding: 2px 5px;
      border-radius: 2px;
      margin-left: 4px;
    }

    .diff-badge.up { color: var(--up); background: rgba(46,204,113,0.1); }
    .diff-badge.down { color: var(--down); background: rgba(231,76,60,0.1); }
    .diff-badge.same { color: var(--same); }

    .combined-cell { font-weight: 700; }

    /* â”€â”€â”€ HEATMAP â”€â”€â”€ */
    .heatmap-section {
      margin-bottom: 32px;
    }

    .heatmap-grid {
      display: flex;
      flex-direction: column;
      gap: 0;
    }
    .heatmap-rank-row {
      display: flex;
      align-items: stretch;
      gap: 8px;
      padding: 8px 0;
      border-top: 1px solid var(--border);
    }
    .heatmap-rank-row:first-child {
      border-top: none;
    }
    .heatmap-rank-label {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.3rem;
      letter-spacing: 2px;
      color: var(--red-glow);
      width: 48px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 10px;
    }
    .heatmap-cards-wrap {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      flex: 1;
    }

    .heatmap-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 3px;
      padding: 8px 6px;
      cursor: pointer;
      transition: transform 0.15s;
      position: relative;
      overflow: hidden;
      width: 88px;
      flex-shrink: 0;
      box-sizing: border-box;
      text-align: center;
    }

    .heatmap-card:hover { transform: scale(1.03); }

    .heatmap-card .hm-country {
      font-size: 0.82rem;
      color: #ffffff;
      font-weight: 700;
      letter-spacing: 0.3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-shadow: -1px -1px 0 #000,1px -1px 0 #000,-1px 1px 0 #000,1px 1px 0 #000;
    }
    .heatmap-card .hm-cdiff {
      font-size: 0.65rem;
      font-weight: 700;
      line-height: 1.3;
    }
    .heatmap-card .hm-edition {
      font-size: 0.68rem;
      color: rgba(255,255,255,0.8);
      line-height: 1.4;
      margin-top: 3px;
    }


    /* â”€â”€â”€ FLAG CONTROLS â”€â”€â”€ */
    .flag-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-left: auto;
    }
    .flag-toggle-btn {
      font-size: 0.68rem;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      color: var(--muted);
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 3px;
      padding: 4px 10px;
      cursor: pointer;
      transition: color 0.2s, border-color 0.2s;
      white-space: nowrap;
    }
    .flag-toggle-btn:hover { color: var(--text); border-color: var(--muted); }
    .flag-toggle-btn.active { color: var(--red-glow); border-color: var(--red-glow); }
    .flag-opacity-wrap {
      display: flex;
      align-items: center;
      gap: 7px;
    }
    .flag-opacity-label {
      font-size: 0.68rem;
      letter-spacing: 1px;
      color: var(--muted);
      white-space: nowrap;
    }
    .flag-opacity-slider {
      -webkit-appearance: none;
      appearance: none;
      width: 90px;
      height: 3px;
      border-radius: 2px;
      background: var(--border);
      outline: none;
      cursor: pointer;
    }
    .flag-opacity-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 13px;
      height: 13px;
      border-radius: 50%;
      background: var(--red-glow);
      cursor: pointer;
    }
    .flag-opacity-slider::-moz-range-thumb {
      width: 13px;
      height: 13px;
      border-radius: 50%;
      background: var(--red-glow);
      cursor: pointer;
      border: none;
    }
    /* â”€â”€â”€ COUNTRY MODAL â”€â”€â”€ */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.82);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s;
    }
    .modal-backdrop.open {
      opacity: 1;
      pointer-events: all;
    }
    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      width: 100%;
      max-width: 680px;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(20px);
      transition: transform 0.25s;
      position: relative;
    }
    .modal-backdrop.open .modal {
      transform: translateY(0);
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px 16px;
      border-bottom: 1px solid var(--border);
    }
    .modal-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .modal-flag { font-size: 2rem; }
    .modal-country-name {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.6rem;
      letter-spacing: 2px;
      color: var(--text);
    }
    .modal-close {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 3px;
      line-height: 1;
      transition: color 0.15s, background 0.15s;
    }
    .modal-close:hover { color: var(--text); background: var(--surface2); }

    .modal-stats-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1px;
      background: var(--border);
      border-bottom: 1px solid var(--border);
    }
    .modal-stat {
      background: var(--surface2);
      padding: 14px 16px;
      text-align: center;
    }
    .modal-stat-label {
      font-size: 0.62rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .modal-stat-value {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.8rem;
      line-height: 1;
      color: var(--red-glow);
    }
    .modal-stat-value.gold { color: var(--gold); }
    .modal-stat-diff {
      font-size: 0.7rem;
      color: var(--muted);
      margin-top: 3px;
    }
    .modal-stat-diff.up { color: var(--up); }
    .modal-stat-diff.down { color: var(--down); }

    .modal-chart-wrap {
      padding: 20px 24px 16px;
    }
    .modal-chart-title {
      font-size: 0.65rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 12px;
    }
    .modal-chart-inner { position: relative; height: 200px; }

    /* â”€â”€â”€ SALES ESTIMATE SECTION â”€â”€â”€ */
    .sales-section { margin-bottom: 32px; }

    .sales-stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 1px;
      background: var(--border);
      border-radius: 4px 4px 0 0;
      overflow: hidden;
      margin-bottom: 1px;
    }

    .sales-stat-box {
      background: var(--surface);
      padding: 16px 20px;
      text-align: center;
    }

    .sales-stat-label {
      font-size: 0.62rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .sales-stat-value {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.7rem;
      line-height: 1;
      color: #2ecc71;
    }

    .sales-stat-value.std  { color: #2E86AB; }
    .sales-stat-value.dlx  { color: #A23B72; }
    .sales-stat-value.tot  { color: #2ecc71; }
    .sales-stat-value.cum  { color: var(--gold); }

    .sales-stat-sub {
      font-size: 0.68rem;
      color: var(--muted);
      margin-top: 3px;
    }

    .sales-chart-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 0 0 4px 4px;
      padding: 20px 24px 16px;
    }

    .sales-tab-row {
      display: flex;
      gap: 0;
      margin-bottom: 16px;
      border: 1px solid var(--border);
      border-radius: 3px;
      overflow: hidden;
      width: fit-content;
    }

    .sales-tab-btn {
      padding: 6px 14px;
      background: var(--surface2);
      border: none;
      color: var(--muted);
      font-size: 0.72rem;
      letter-spacing: 1px;
      text-transform: uppercase;
      cursor: pointer;
      border-right: 1px solid var(--border);
      transition: all 0.15s;
      font-family: 'Noto Sans KR', sans-serif;
    }

    .sales-tab-btn:last-child { border-right: none; }
    .sales-tab-btn:hover { color: var(--text); background: var(--surface); }
    .sales-tab-btn.active { background: var(--red); color: #fff; }

    .sales-chart-inner { position: relative; height: 240px; }

    .sales-note {
      font-size: 0.65rem;
      color: var(--muted);
      margin-top: 10px;
      line-height: 1.6;
      border-top: 1px solid var(--border);
      padding-top: 10px;
    }

    /* â”€â”€â”€ TRENDS SECTION â”€â”€â”€ */
    .trends-section { margin-bottom: 32px; }

    .trends-stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1px;
      background: var(--border);
      border-radius: 4px 4px 0 0;
      overflow: hidden;
      margin-bottom: 1px;
    }

    .trends-stat-box {
      background: var(--surface);
      padding: 16px 20px;
      text-align: center;
    }

    .trends-stat-label {
      font-size: 0.62rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .trends-stat-value {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 2rem;
      line-height: 1;
      color: #4285F4;
    }

    .trends-stat-value.yt   { color: #FF0000; }
    .trends-stat-value.high { color: var(--gold); }

    .trends-stat-sub {
      font-size: 0.68rem;
      color: var(--muted);
      margin-top: 3px;
    }

    .trends-chart-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 0 0 4px 4px;
      padding: 20px 24px 16px;
    }

    .trends-chart-inner { position: relative; height: 220px; }

    .trends-countries-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 6px;
      margin-top: 16px;
    }

    .trends-country-card {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 3px;
      padding: 10px 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .trends-country-flag { font-size: 1.2rem; }

    .trends-country-info { flex: 1; min-width: 0; }

    .trends-country-name {
      font-size: 0.72rem;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .trends-country-score {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.3rem;
      line-height: 1;
      color: #4285F4;
    }

    .trends-score-bar {
      height: 3px;
      background: var(--border);
      border-radius: 2px;
      margin-top: 4px;
      overflow: hidden;
    }

    .trends-score-fill {
      height: 100%;
      background: #4285F4;
      border-radius: 2px;
      transition: width 0.5s ease;
    }

    /* â”€â”€â”€ STEAM SECTION â”€â”€â”€ */
    .steam-section {
      margin-bottom: 32px;
    }

    .steam-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .steam-title-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .steam-icon {
      font-size: 1.2rem;
    }

    .steamdb-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 7px 14px;
      background: #1b2838;
      border: 1px solid #2a475e;
      border-radius: 3px;
      color: #c7d5e0;
      font-size: 0.72rem;
      letter-spacing: 1px;
      text-decoration: none;
      font-family: 'Noto Sans KR', sans-serif;
      transition: background 0.2s, border-color 0.2s;
      white-space: nowrap;
    }

    .steamdb-btn:hover {
      background: #2a475e;
      border-color: #4fc3f7;
      color: #fff;
    }

    .steam-stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 1px;
      background: var(--border);
      border-radius: 4px 4px 0 0;
      overflow: hidden;
      margin-bottom: 1px;
    }

    .steam-stat-box {
      background: var(--surface);
      padding: 16px 20px;
      text-align: center;
    }

    .steam-stat-label {
      font-size: 0.62rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .steam-stat-value {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 2rem;
      line-height: 1;
      color: #4fc3f7;
    }

    .steam-stat-diff {
      font-size: 0.7rem;
      color: var(--muted);
      margin-top: 3px;
    }

    .steam-stat-diff.up   { color: var(--up); }
    .steam-stat-diff.down { color: var(--down); }

    .steam-chart-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 0 0 4px 4px;
      padding: 20px 24px 16px;
    }

    .steam-chart-label {
      font-size: 0.62rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 12px;
    }

    .steam-chart-inner { position: relative; height: 200px; }

    /* â”€â”€â”€ FOOTER â”€â”€â”€ */
    footer {
      text-align: center;
      padding: 24px;
      font-size: 0.72rem;
      color: var(--muted);
      border-top: 1px solid var(--border);
      letter-spacing: 1px;
    }

    /* â”€â”€â”€ LOADING / ERROR â”€â”€â”€ */
    #loading-screen {
      position: fixed;
      inset: 0;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
      transition: opacity 0.5s;
    }

    .loader-title {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 2rem;
      letter-spacing: 6px;
      color: var(--red-glow);
      margin-bottom: 20px;
    }

    .loader-bar {
      width: 200px;
      height: 2px;
      background: var(--border);
      border-radius: 1px;
      overflow: hidden;
    }

    .loader-fill {
      height: 100%;
      background: var(--red-glow);
      animation: load-anim 1.5s ease-in-out infinite;
    }

    @keyframes load-anim {
      0% { width: 0%; margin-left: 0; }
      50% { width: 60%; margin-left: 20%; }
      100% { width: 0%; margin-left: 100%; }
    }

    .fade-in { animation: fadeIn 0.5s ease forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }

    .row-enter { animation: rowEnter 0.3s ease forwards; }
    @keyframes rowEnter { from { opacity: 0; } to { opacity: 1; } }

    /* ë°˜ì‘í˜• */
    @media (max-width: 640px) {
      .hero-stats { grid-template-columns: repeat(2, 1fr); }
      .tabs { font-size: 0.8rem; }
      th, td { padding: 8px 10px; }
      .weight-badge { display: none; }
    }
  </style>
</head>
<body>

<div id="loading-screen">
  <div class="loader-title">LOADING DATA</div>
  <div class="loader-bar"><div class="loader-fill"></div></div>
</div>

<div id="app" style="opacity:0">
  <header>
    <div class="logo-line">
      <div class="logo-icon">âš”ï¸</div>
      <h1>CRIMSON <span>DESERT</span></h1>
    </div>
    <div class="subtitle">PlayStation Store â€” Global Pre-order Rank Tracker</div>
    <div class="meta-row">
      <span>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <strong id="last-updated">â€”</strong></span>
      <span>ì¶”ì  êµ­ê°€: <strong id="country-count">â€”</strong>ê°œêµ­</span>
      <span>íˆìŠ¤í† ë¦¬: <strong id="history-count">â€”</strong>íšŒ</span>
    </div>
  </header>

  <div class="container">
    <!-- HERO STATS -->
    <div class="hero-stats fade-in" id="hero-stats">
      <div class="stat-box">
        <div class="stat-label">ì „ì²´ ê°€ì¤‘ í‰ê·  ìˆœìœ„</div>
        <div class="stat-value" id="stat-combined">â€”</div>
        <div class="stat-diff" id="stat-combined-diff"></div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Americas í‰ê· </div>
        <div class="stat-value gold" id="stat-americas">â€”</div>
        <div class="stat-diff" id="stat-americas-diff"></div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Europe & ME í‰ê· </div>
        <div class="stat-value neutral" id="stat-europe">â€”</div>
        <div class="stat-diff" id="stat-europe-diff"></div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Asia & Oceania í‰ê· </div>
        <div class="stat-value" id="stat-asia">â€”</div>
        <div class="stat-diff" id="stat-asia-diff"></div>
      </div>
      <div class="stat-box">
        <div class="stat-label">ìµœê³  ìˆœìœ„ êµ­ê°€</div>
        <div class="stat-value gold" id="stat-best-flag" style="font-size:2rem">â€”</div>
        <div class="stat-diff" id="stat-best-name"></div>
      </div>
    </div>

    <!-- COUNTDOWN -->
    <div class="countdown-section fade-in">
      <div class="countdown-title">ğŸš€ ì¶œì‹œ ì¹´ìš´íŠ¸ë‹¤ìš´</div>
      <div class="countdown-regions" id="countdown-grid"></div>
    </div>

    <!-- CHART -->
    <div class="chart-section fade-in">
      <div class="section-title">ìˆœìœ„ íˆìŠ¤í† ë¦¬ (ê°€ì¤‘ í‰ê· )</div>
      <div class="event-toggle-wrap" id="ev-toggle-rank">
        <div class="event-toggle-header" onclick="toggleEvPanel('rank')">
          <span class="event-toggle-title">ğŸ“… ì´ë²¤íŠ¸ í‘œì‹œ</span>
          <span class="event-toggle-arrow" id="ev-arrow-rank">â–¼</span>
        </div>
        <div class="event-toggle-panel" id="ev-panel-rank"></div>
      </div>
      <div class="chart-wrapper">
        <canvas id="rankChart"></canvas>
      </div>
    </div>

    <!-- SALES ESTIMATE SECTION -->
    <div class="sales-section fade-in">
      <div class="steam-header">
        <div class="section-title" style="margin-bottom:0">ğŸ’° ì˜ˆìƒ íŒë§¤ëŸ‰ ì¶”ì‚°</div>
        <span style="font-size:0.68rem;color:var(--muted)">ìˆœìœ„ â†’ íŒë§¤ëŸ‰ ëª¨ë¸ ê¸°ë°˜ ì¶”ì •ì¹˜ (ì°¸ê³ ìš©)</span>
      </div>

      <!-- ì˜¤ëŠ˜ ì¶”ì‚° ìŠ¤íƒ¯ -->
      <div class="sales-stats-row">
        <div class="sales-stat-box">
          <div class="sales-stat-label">ì˜¤ëŠ˜ ìŠ¤íƒ ë‹¤ë“œ ì¶”ì‚°</div>
          <div class="sales-stat-value std" id="sales-today-std">â€”</div>
          <div class="sales-stat-sub">units / day</div>
        </div>
        <div class="sales-stat-box">
          <div class="sales-stat-label">ì˜¤ëŠ˜ ë””ëŸ­ìŠ¤ ì¶”ì‚°</div>
          <div class="sales-stat-value dlx" id="sales-today-dlx">â€”</div>
          <div class="sales-stat-sub">units / day</div>
        </div>
        <div class="sales-stat-box">
          <div class="sales-stat-label">ì˜¤ëŠ˜ í•©ê³„ ì¶”ì‚°</div>
          <div class="sales-stat-value tot" id="sales-today-tot">â€”</div>
          <div class="sales-stat-sub">units / day</div>
        </div>
        <div class="sales-stat-box">
          <div class="sales-stat-label">ëˆ„ì  í•©ê³„ (ì´)</div>
          <div class="sales-stat-value cum" id="sales-cumulative">â€”</div>
          <div class="sales-stat-sub" id="sales-cumulative-range">â€”</div>
        </div>
      </div>

      <!-- ì°¨íŠ¸ -->
      <div class="sales-chart-box">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px">
          <span style="font-size:0.62rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted)">ì¼ë³„ / ëˆ„ì  íŒë§¤ëŸ‰ ì¶”ì‚°</span>
          <div class="sales-tab-row">
            <button class="sales-tab-btn active" onclick="switchSalesTab('daily', this)">ì¼ë³„</button>
            <button class="sales-tab-btn" onclick="switchSalesTab('cumulative', this)">ëˆ„ì </button>
          </div>
        </div>
        <div class="event-toggle-wrap">
          <div class="event-toggle-header" onclick="toggleEvPanel('sales')">
            <span class="event-toggle-title">ğŸ“… ì´ë²¤íŠ¸ í‘œì‹œ</span>
            <span class="event-toggle-arrow" id="ev-arrow-sales">â–¼</span>
          </div>
          <div class="event-toggle-panel" id="ev-panel-sales"></div>
        </div>
        <div class="sales-chart-inner">
          <canvas id="salesChart"></canvas>
        </div>
        <div class="sales-note">
          ğŸ“Œ ì¶”ì‚° ê¸°ì¤€: ìˆœìœ„â†’íŒë§¤ëŸ‰ 2êµ¬ê°„ ì§€ìˆ˜ ê³¡ì„  (1ìœ„=600/ì¼, 20ìœ„=70/ì¼, 100ìœ„=15/ì¼) Ã— êµ­ê°€ë³„ PS ì‹œì¥ ê°€ì¤‘ì¹˜ (ë¯¸êµ­=10 ê¸°ì¤€)<br>
          ğŸŸ¡ ì ì„  êµ¬ê°„ = ê³¼ê±° í‰ê·  ìˆœìœ„ ê¸°ë°˜ ì¶”ì • (2025.9~2026.1.11) | ì‹¤ì„  êµ¬ê°„ = êµ­ê°€ë³„ ì‹¤ì œ ë°ì´í„° (2026.1.12~)
        </div>
      </div>
    </div>

    <!-- TRENDS SECTION -->
    <div class="trends-section fade-in">
      <div class="steam-header">
        <div class="section-title" style="margin-bottom:0">ğŸ” Google ê²€ìƒ‰ íŠ¸ë Œë“œ</div>
        <span style="font-size:0.68rem;color:var(--muted)">ê´€ì‹¬ë„ 0~100 (ìƒëŒ€ ìˆ˜ì¹˜)</span>
      </div>

      <!-- ìŠ¤íƒ¯ -->
      <div class="trends-stats-row">
        <div class="trends-stat-box">
          <div class="trends-stat-label">Google ê¸€ë¡œë²Œ í˜„ì¬</div>
          <div class="trends-stat-value" id="trends-google-now">â€”</div>
          <div class="trends-stat-sub" id="trends-google-diff">/ 100</div>
        </div>
        <div class="trends-stat-box">
          <div class="trends-stat-label">Google ì „ì²´ í‰ê· </div>
          <div class="trends-stat-value" id="trends-google-avg">â€”</div>
          <div class="trends-stat-sub">/ 100</div>
        </div>
        <div class="trends-stat-box">
          <div class="trends-stat-label">ì—­ëŒ€ ìµœê³ </div>
          <div class="trends-stat-value high" id="trends-google-peak">â€”</div>
          <div class="trends-stat-sub" id="trends-google-peak-date"></div>
        </div>
      </div>

      <!-- ê¸€ë¡œë²Œ íˆìŠ¤í† ë¦¬ ì°¨íŠ¸ -->
      <div class="trends-chart-box">
        <div style="font-size:0.62rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:8px">ê²€ìƒ‰ ê´€ì‹¬ë„ íˆìŠ¤í† ë¦¬ (ê¸€ë¡œë²Œ)</div>
        <div class="event-toggle-wrap">
          <div class="event-toggle-header" onclick="toggleEvPanel('trends')">
            <span class="event-toggle-title">ğŸ“… ì´ë²¤íŠ¸ í‘œì‹œ</span>
            <span class="event-toggle-arrow" id="ev-arrow-trends">â–¼</span>
          </div>
          <div class="event-toggle-panel" id="ev-panel-trends"></div>
        </div>
        <div class="trends-chart-inner">
          <canvas id="trendsChart"></canvas>
        </div>

        <!-- êµ­ê°€ë³„ ìµœì‹  ìŠ¤ì½”ì–´ -->
        <div style="font-size:0.62rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin:16px 0 8px">ì½˜ì†” ì£¼ìš” 5ê°œêµ­ ìµœì‹  ê´€ì‹¬ë„</div>
        <div class="trends-countries-grid" id="trends-countries-grid"></div>
      </div>
    </div>

    <!-- STEAM SECTION -->
    <div class="steam-section fade-in">
      <div class="steam-header">
        <div class="steam-title-row">
          <div class="section-title" style="margin-bottom:0">ğŸ® Steam ìœ„ì‹œë¦¬ìŠ¤íŠ¸ ìˆœìœ„</div>
        </div>
        <a class="steamdb-btn" href="https://steamdb.info/app/3321460/charts/" target="_blank">
          ğŸ”— SteamDBì—ì„œ ìì„¸íˆ ë³´ê¸° â†—
        </a>
      </div>
      <div class="steam-stats-row">
        <div class="steam-stat-box">
          <div class="steam-stat-label">í˜„ì¬ ìˆœìœ„</div>
          <div class="steam-stat-value" id="steam-rank-current">â€”</div>
          <div class="steam-stat-diff" id="steam-rank-diff"></div>
        </div>
        <div class="steam-stat-box">
          <div class="steam-stat-label">ìµœê³  ìˆœìœ„</div>
          <div class="steam-stat-value" id="steam-rank-best">â€”</div>
          <div class="steam-stat-diff" style="color:var(--muted);font-size:0.7rem" id="steam-rank-best-date"></div>
        </div>
        <div class="steam-stat-box">
          <div class="steam-stat-label">ì¶”ì  ì‹œì‘</div>
          <div class="steam-stat-value" id="steam-rank-first">â€”</div>
          <div class="steam-stat-diff" id="steam-rank-first-date"></div>
        </div>
        <div class="steam-stat-box">
          <div class="steam-stat-label">ì´ ê¸°ë¡ ìˆ˜</div>
          <div class="steam-stat-value" id="steam-count">â€”</div>
          <div class="steam-stat-diff">ê°œ ë°ì´í„°í¬ì¸íŠ¸</div>
        </div>
      </div>
      <div class="steam-chart-box">
        <div class="steam-chart-label">ìœ„ì‹œë¦¬ìŠ¤íŠ¸ ìˆœìœ„ íˆìŠ¤í† ë¦¬</div>
        <div class="event-toggle-wrap">
          <div class="event-toggle-header" onclick="toggleEvPanel('steam')">
            <span class="event-toggle-title">ğŸ“… ì´ë²¤íŠ¸ í‘œì‹œ</span>
            <span class="event-toggle-arrow" id="ev-arrow-steam">â–¼</span>
          </div>
          <div class="event-toggle-panel" id="ev-panel-steam"></div>
        </div>
        <div class="steam-chart-inner">
          <canvas id="steamChart"></canvas>
        </div>
      </div>
    </div>

    <!-- HEATMAP -->
    <div class="heatmap-section fade-in">
      <div class="section-title" style="display:flex;align-items:center">
        ì „ì„¸ê³„ í˜„í™© í•œëˆˆì—
        <div class="flag-controls">
          <button class="flag-toggle-btn active" id="flag-toggle-btn" onclick="toggleFlag()">ğŸ³ êµ­ê¸° ON</button>
          <div class="flag-opacity-wrap" id="flag-opacity-wrap">
            <span class="flag-opacity-label">íˆ¬ëª…ë„</span>
            <input type="range" class="flag-opacity-slider" id="flag-opacity-slider"
              min="0" max="100" value="52" oninput="updateFlagOpacity(this.value)">
          </div>
        </div>
      </div>
      <div class="heatmap-grid" id="heatmap-grid"></div>
    </div>

    <!-- TABLE -->
    <div class="fade-in">
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('all', this)">ALL</button>
        <button class="tab-btn" onclick="switchTab('americas', this)">Americas</button>
        <button class="tab-btn" onclick="switchTab('europe', this)">Europe & ME</button>
        <button class="tab-btn" onclick="switchTab('asia', this)">Asia & Oceania</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th class="sortable" onclick="setSort('name')">êµ­ê°€ <span class="sort-icon" id="sort-icon-name">â‡…</span></th>
              <th class="sortable" onclick="setSort('standard')">ìŠ¤íƒ ë‹¤ë“œ <span class="sort-icon" id="sort-icon-standard">â‡…</span></th>
              <th class="sortable" onclick="setSort('deluxe')">ë””ëŸ­ìŠ¤ <span class="sort-icon" id="sort-icon-deluxe">â‡…</span></th>
              <th class="sortable" onclick="setSort('combined')">ì¢…í•© (Best) <span class="sort-icon" id="sort-icon-combined">â‡…</span></th>
              <th class="sortable" onclick="setSort('weight')">ê°€ì¤‘ì¹˜ <span class="sort-icon" id="sort-icon-weight">â‡…</span></th>
            </tr>
          </thead>
          <tbody id="rank-table"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- COUNTRY DETAIL MODAL -->
  <div class="modal-backdrop" id="country-modal" onclick="closeModal(event)">
    <div class="modal" id="modal-box">
      <div class="modal-header">
        <div class="modal-title">
          <span class="modal-flag" id="modal-flag"></span>
          <span class="modal-country-name" id="modal-name"></span>
        </div>
        <button class="modal-close" onclick="closeModalDirect()">âœ•</button>
      </div>
      <div class="modal-stats-row">
        <div class="modal-stat">
          <div class="modal-stat-label">ìŠ¤íƒ ë‹¤ë“œ</div>
          <div class="modal-stat-value" id="modal-standard">â€”</div>
          <div class="modal-stat-diff" id="modal-standard-diff"></div>
        </div>
        <div class="modal-stat">
          <div class="modal-stat-label">ë””ëŸ­ìŠ¤</div>
          <div class="modal-stat-value" id="modal-deluxe">â€”</div>
          <div class="modal-stat-diff" id="modal-deluxe-diff"></div>
        </div>
        <div class="modal-stat">
          <div class="modal-stat-label">ì¢…í•© (Best)</div>
          <div class="modal-stat-value gold" id="modal-combined">â€”</div>
          <div class="modal-stat-diff" id="modal-combined-diff"></div>
        </div>
      </div>
      <div class="modal-chart-wrap">
        <div class="modal-chart-title">ìˆœìœ„ íˆìŠ¤í† ë¦¬</div>
        <div class="modal-chart-inner">
          <canvas id="modalChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <footer>
    CRIMSON DESERT PS STORE TRACKER &nbsp;Â·&nbsp; DATA UPDATES VIA GITHUB ACTIONS &nbsp;Â·&nbsp; AUTO-REFRESHES EVERY 30 MIN
  </footer>
</div>

<script>
// â”€â”€â”€ ë°ì´í„° ì„¤ì • â”€â”€â”€
const REGIONS = {
  "Americas": ["ë¯¸êµ­","ìºë‚˜ë‹¤","ë¸Œë¼ì§ˆ","ë©•ì‹œì½”","ì•„ë¥´í—¨í‹°ë‚˜","ì¹ ë ˆ","ì½œë¡¬ë¹„ì•„","í˜ë£¨","ìš°ë£¨ê³¼ì´","ë³¼ë¦¬ë¹„ì•„","ê³¼í…Œë§ë¼","ì˜¨ë‘ë¼ìŠ¤"],
  "Europe & Middle East": ["ì˜êµ­","ë…ì¼","í”„ë‘ìŠ¤","ìŠ¤í˜ì¸","ì´íƒˆë¦¬ì•„","ë„¤ëœë€ë“œ","í´ë€ë“œ","ìŠ¤ìœ„ìŠ¤","ìŠ¤ì›¨ë´","ë…¸ë¥´ì›¨ì´","ë´ë§ˆí¬","í•€ë€ë“œ","í¬ë¥´íˆ¬ê°ˆ","ê·¸ë¦¬ìŠ¤","ì²´ì½”","í—ê°€ë¦¬","ë£¨ë§ˆë‹ˆì•„","ìŠ¬ë¡œë°”í‚¤ì•„","ìŠ¬ë¡œë² ë‹ˆì•„","ìš°í¬ë¼ì´ë‚˜","ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„","ì•„ëì—ë¯¸ë¦¬íŠ¸","ë‚¨ì•„ê³µ"],
  "Asia & Oceania": ["ì¼ë³¸","í•œêµ­","ì¤‘êµ­","í˜¸ì£¼","ì¸ë„","íƒœêµ­","ì‹±ê°€í¬ë¥´","ë§ë ˆì´ì‹œì•„","ì¸ë„ë„¤ì‹œì•„","í•„ë¦¬í•€","ë² íŠ¸ë‚¨","í™ì½©","ëŒ€ë§Œ","ë‰´ì§ˆëœë“œ"]
};

const MARKET_WEIGHTS = {
  "ë¯¸êµ­":30.0,"ìºë‚˜ë‹¤":4.5,"ë¸Œë¼ì§ˆ":2.5,"ë©•ì‹œì½”":2.0,"ì•„ë¥´í—¨í‹°ë‚˜":0.9,"ì¹ ë ˆ":0.8,"ì½œë¡¬ë¹„ì•„":0.7,"í˜ë£¨":0.4,"ìš°ë£¨ê³¼ì´":0.3,"ë³¼ë¦¬ë¹„ì•„":0.2,"ê³¼í…Œë§ë¼":0.2,"ì˜¨ë‘ë¼ìŠ¤":0.2,
  "ì˜êµ­":8.5,"ë…ì¼":6.5,"í”„ë‘ìŠ¤":6.0,"ìŠ¤í˜ì¸":4.0,"ì´íƒˆë¦¬ì•„":3.5,"ë„¤ëœë€ë“œ":1.8,"ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„":1.5,"ì•„ëì—ë¯¸ë¦¬íŠ¸":1.2,"í´ë€ë“œ":1.2,"ìŠ¤ìœ„ìŠ¤":1.0,"ìŠ¤ì›¨ë´":1.0,"ë´ë§ˆí¬":0.9,"í¬ë¥´íˆ¬ê°ˆ":0.8,"í•€ë€ë“œ":0.8,"ë…¸ë¥´ì›¨ì´":0.8,"ë‚¨ì•„ê³µ":0.8,"ì²´ì½”":0.7,"ë£¨ë§ˆë‹ˆì•„":0.6,"ê·¸ë¦¬ìŠ¤":0.5,"í—ê°€ë¦¬":0.5,"ìš°í¬ë¼ì´ë‚˜":0.5,"ìŠ¬ë¡œë°”í‚¤ì•„":0.3,"ìŠ¬ë¡œë² ë‹ˆì•„":0.3,
  "ì¼ë³¸":8.0,"í˜¸ì£¼":3.0,"í•œêµ­":2.8,"ì¸ë„":2.0,"ëŒ€ë§Œ":1.0,"ì‹±ê°€í¬ë¥´":0.8,"íƒœêµ­":0.9,"í™ì½©":0.9,"ì¸ë„ë„¤ì‹œì•„":0.8,"ë§ë ˆì´ì‹œì•„":0.7,"ë² íŠ¸ë‚¨":0.7,"í•„ë¦¬í•€":0.6,"ë‰´ì§ˆëœë“œ":0.6,"ì¤‘êµ­":0.2
};

const FLAGS = {
  "ë¯¸êµ­":"ğŸ‡ºğŸ‡¸","ìºë‚˜ë‹¤":"ğŸ‡¨ğŸ‡¦","ë¸Œë¼ì§ˆ":"ğŸ‡§ğŸ‡·","ë©•ì‹œì½”":"ğŸ‡²ğŸ‡½","ì•„ë¥´í—¨í‹°ë‚˜":"ğŸ‡¦ğŸ‡·","ì¹ ë ˆ":"ğŸ‡¨ğŸ‡±","ì½œë¡¬ë¹„ì•„":"ğŸ‡¨ğŸ‡´","í˜ë£¨":"ğŸ‡µğŸ‡ª","ìš°ë£¨ê³¼ì´":"ğŸ‡ºğŸ‡¾","ë³¼ë¦¬ë¹„ì•„":"ğŸ‡§ğŸ‡´","ê³¼í…Œë§ë¼":"ğŸ‡¬ğŸ‡¹","ì˜¨ë‘ë¼ìŠ¤":"ğŸ‡­ğŸ‡³",
  "ì˜êµ­":"ğŸ‡¬ğŸ‡§","ë…ì¼":"ğŸ‡©ğŸ‡ª","í”„ë‘ìŠ¤":"ğŸ‡«ğŸ‡·","ìŠ¤í˜ì¸":"ğŸ‡ªğŸ‡¸","ì´íƒˆë¦¬ì•„":"ğŸ‡®ğŸ‡¹","ë„¤ëœë€ë“œ":"ğŸ‡³ğŸ‡±","í´ë€ë“œ":"ğŸ‡µğŸ‡±","ìŠ¤ìœ„ìŠ¤":"ğŸ‡¨ğŸ‡­","ìŠ¤ì›¨ë´":"ğŸ‡¸ğŸ‡ª","ë…¸ë¥´ì›¨ì´":"ğŸ‡³ğŸ‡´","ë´ë§ˆí¬":"ğŸ‡©ğŸ‡°","í•€ë€ë“œ":"ğŸ‡«ğŸ‡®","í¬ë¥´íˆ¬ê°ˆ":"ğŸ‡µğŸ‡¹","ê·¸ë¦¬ìŠ¤":"ğŸ‡¬ğŸ‡·","ì²´ì½”":"ğŸ‡¨ğŸ‡¿","í—ê°€ë¦¬":"ğŸ‡­ğŸ‡º","ë£¨ë§ˆë‹ˆì•„":"ğŸ‡·ğŸ‡´","ìŠ¬ë¡œë°”í‚¤ì•„":"ğŸ‡¸ğŸ‡°","ìŠ¬ë¡œë² ë‹ˆì•„":"ğŸ‡¸ğŸ‡®","ìš°í¬ë¼ì´ë‚˜":"ğŸ‡ºğŸ‡¦","ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„":"ğŸ‡¸ğŸ‡¦","ì•„ëì—ë¯¸ë¦¬íŠ¸":"ğŸ‡¦ğŸ‡ª","ë‚¨ì•„ê³µ":"ğŸ‡¿ğŸ‡¦",
  "ì¼ë³¸":"ğŸ‡¯ğŸ‡µ","í•œêµ­":"ğŸ‡°ğŸ‡·","ì¤‘êµ­":"ğŸ‡¨ğŸ‡³","í˜¸ì£¼":"ğŸ‡¦ğŸ‡º","ì¸ë„":"ğŸ‡®ğŸ‡³","íƒœêµ­":"ğŸ‡¹ğŸ‡­","ì‹±ê°€í¬ë¥´":"ğŸ‡¸ğŸ‡¬","ë§ë ˆì´ì‹œì•„":"ğŸ‡²ğŸ‡¾","ì¸ë„ë„¤ì‹œì•„":"ğŸ‡®ğŸ‡©","í•„ë¦¬í•€":"ğŸ‡µğŸ‡­","ë² íŠ¸ë‚¨":"ğŸ‡»ğŸ‡³","í™ì½©":"ğŸ‡­ğŸ‡°","ëŒ€ë§Œ":"ğŸ‡¹ğŸ‡¼","ë‰´ì§ˆëœë“œ":"ğŸ‡³ğŸ‡¿"
};

// â”€â”€â”€ PS Store URL ìë™ ì „í™˜ (ì¶œì‹œ ì „: ì‚¬ì „ì˜ˆì•½ / ì¶œì‹œ í›„: ì‹ ì‘ ë² ìŠ¤íŠ¸ì…€ëŸ¬) â”€â”€â”€
const PREORDER_CATEGORY   = "3bf499d7-7acf-4931-97dd-2667494ee2c9";
const BESTSELLER_CATEGORY = "e1699f77-77e1-43ca-a296-26d08abacb0f";
const RELEASE_DATE_KST    = new Date("2026-03-20T00:00:00+09:00");

const LOCALE_MAP = {
  "ë¯¸êµ­": "en-us", "ìºë‚˜ë‹¤": "en-ca", "ë¸Œë¼ì§ˆ": "pt-br", "ë©•ì‹œì½”": "es-mx",
  "ì•„ë¥´í—¨í‹°ë‚˜": "es-ar", "ì¹ ë ˆ": "es-cl", "ì½œë¡¬ë¹„ì•„": "es-co", "í˜ë£¨": "es-pe",
  "ìš°ë£¨ê³¼ì´": "es-uy", "ë³¼ë¦¬ë¹„ì•„": "es-bo", "ê³¼í…Œë§ë¼": "es-gt", "ì˜¨ë‘ë¼ìŠ¤": "es-hn",
  "ì˜êµ­": "en-gb", "ë…ì¼": "de-de", "í”„ë‘ìŠ¤": "fr-fr", "ìŠ¤í˜ì¸": "es-es",
  "ì´íƒˆë¦¬ì•„": "it-it", "ë„¤ëœë€ë“œ": "nl-nl", "í´ë€ë“œ": "pl-pl", "ìŠ¤ìœ„ìŠ¤": "de-ch",
  "ìŠ¤ì›¨ë´": "sv-se", "ë…¸ë¥´ì›¨ì´": "no-no", "ë´ë§ˆí¬": "da-dk", "í•€ë€ë“œ": "fi-fi",
  "í¬ë¥´íˆ¬ê°ˆ": "pt-pt", "ê·¸ë¦¬ìŠ¤": "el-gr", "ì²´ì½”": "cs-cz", "í—ê°€ë¦¬": "hu-hu",
  "ë£¨ë§ˆë‹ˆì•„": "ro-ro", "ìŠ¬ë¡œë°”í‚¤ì•„": "sk-sk", "ìŠ¬ë¡œë² ë‹ˆì•„": "sl-si", "ìš°í¬ë¼ì´ë‚˜": "uk-ua",
  "ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„": "en-sa", "ì•„ëì—ë¯¸ë¦¬íŠ¸": "en-ae", "ë‚¨ì•„ê³µ": "en-za",
  "ì¼ë³¸": "ja-jp", "í•œêµ­": "ko-kr", "í˜¸ì£¼": "en-au", "ì¸ë„": "en-in",
  "íƒœêµ­": "th-th", "ì‹±ê°€í¬ë¥´": "en-sg", "ë§ë ˆì´ì‹œì•„": "en-my", "ì¸ë„ë„¤ì‹œì•„": "id-id",
  "í•„ë¦¬í•€": "en-ph", "ë² íŠ¸ë‚¨": "vi-vn", "í™ì½©": "zh-hant-hk", "ëŒ€ë§Œ": "zh-hant-tw",
  "ë‰´ì§ˆëœë“œ": "en-nz",
};

function getFlagUrl(country) {
  const locale = LOCALE_MAP[country];
  if (!locale) return null;
  const code = locale.split('-').pop().toLowerCase();
  return `https://flagcdn.com/w160/${code}.png`;
}

function isPostRelease() {
  return new Date() >= RELEASE_DATE_KST;
}

function getPsStoreUrl(country) {
  const locale = LOCALE_MAP[country];
  if (!locale) return null;  // ì¤‘êµ­ ë“± locale ì—†ëŠ” êµ­ê°€
  const category = isPostRelease() ? BESTSELLER_CATEGORY : PREORDER_CATEGORY;
  return `https://store.playstation.com/${locale}/category/${category}/1`;
}

// í•˜ìœ„ í˜¸í™˜ìš© URLS ê°ì²´ (ê¸°ì¡´ ì½”ë“œì—ì„œ URLS[country] ì°¸ì¡°í•˜ëŠ” ê³³ ëŒ€ì‘)
const URLS = new Proxy({}, {
  get(_, country) { return getPsStoreUrl(country); }
});

// â”€â”€â”€ ìœ í‹¸ í•¨ìˆ˜ â”€â”€â”€
function combinedRank(s, d) {
  if (s && d) return Math.min(s, d);
  return s || d || null;
}

function calcAvg(rawResults, countries) {
  let sum = 0, w = 0;
  const list = countries || Object.keys(rawResults);
  list.forEach(c => {
    if (!rawResults[c]) return;
    const cr = combinedRank(rawResults[c].standard, rawResults[c].deluxe);
    const wt = MARKET_WEIGHTS[c] || 1;
    if (cr) { sum += cr * wt; w += wt; }
  });
  return w > 0 ? sum / w : null;
}

function diffBadge(curr, prev) {
  if (curr == null || prev == null) return '';
  const d = prev - curr; // ì‘ì•„ì§€ë©´ ìƒìŠ¹
  if (d > 0) return `<span class="diff-badge up">â–²${d}</span>`;
  if (d < 0) return `<span class="diff-badge down">â–¼${Math.abs(d)}</span>`;
  return `<span class="diff-badge same">â€”</span>`;
}

function rankColor(rank) {
  if (rank == null) return '#2a1f22';
  if (rank === 1)  return 'rgba(231,76,60,0.35)';
  if (rank === 2)  return 'rgba(52,152,219,0.25)';
  if (rank === 3)  return 'rgba(241,196,15,0.25)';
  if (rank === 4)  return 'rgba(46,204,113,0.15)';
  if (rank === 5)  return 'rgba(155,89,182,0.15)';
  if (rank <= 10) return 'rgba(160,82,45,0.25)';
  if (rank <= 20) return 'rgba(160,82,45,0.15)';
  if (rank <= 40) return 'rgba(160,82,45,0.07)';
  return 'rgba(50,40,45,0.5)';
}

function rankCardTextColor(rank) {
  return '#ffffff';
}

function rankTextColor(rank) {
  if (!rank) return 'var(--text)';
  if (rank === 1) return '#e74c3c';
  if (rank === 2) return '#3498db';
  if (rank === 3) return '#f1c40f';
  if (rank === 4) return '#2ecc71';
  if (rank === 5) return '#9b59b6';
  if (rank <= 10) return '#a0522d';
  return '#ffffff';
}

function getRegion(country) {
  for (const [r, cs] of Object.entries(REGIONS)) {
    if (cs.includes(country)) return r;
  }
  return null;
}

// â”€â”€â”€ ì „ì—­ ìƒíƒœ â”€â”€â”€
let allHistory = [];
let currentTab = 'all';
let chartInstance = null;

// â”€â”€â”€ ë©”ì¸ ë¡œì§ â”€â”€â”€
async function loadData() {
  try {
    const res = await fetch('rank_history.json?t=' + Date.now());
    if (!res.ok) throw new Error('fetch failed');
    allHistory = await res.json();
  } catch (e) {
    // ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ í‘œì‹œ
    document.getElementById('loading-screen').style.opacity = 0;
    setTimeout(() => document.getElementById('loading-screen').style.display = 'none', 500);
    document.getElementById('app').style.opacity = 1;
    document.getElementById('last-updated').textContent = 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ â€” rank_history.json í™•ì¸';
    return;
  }

  render();

  // ë¡œë”© ìˆ¨ê¸°ê¸°
  const ls = document.getElementById('loading-screen');
  ls.style.opacity = 0;
  setTimeout(() => ls.style.display = 'none', 500);
  const app = document.getElementById('app');
  app.style.transition = 'opacity 0.5s';
  app.style.opacity = 1;
}

function render() {
  if (!allHistory.length) return;

  const latest = allHistory[allHistory.length - 1];
  const prev   = allHistory.length >= 2 ? allHistory[allHistory.length - 2] : null;
  const raw    = latest.raw_results;

  // ë©”íƒ€ ì •ë³´
  const dt = new Date(latest.timestamp);
  document.getElementById('last-updated').textContent = dt.toLocaleString('ko-KR');
  document.getElementById('country-count').textContent = Object.keys(raw).length;
  document.getElementById('history-count').textContent = allHistory.length;

  // HERO STATS
  const combinedAvg = calcAvg(raw, null);
  const prevCombinedAvg = prev ? calcAvg(prev.raw_results, null) : null;
  setHeroStat('stat-combined', 'stat-combined-diff', combinedAvg, prevCombinedAvg, 'ìœ„');

  for (const [regionKey, regionName] of [['americas','Americas'],['europe','Europe & Middle East'],['asia','Asia & Oceania']]) {
    const countries = REGIONS[regionName];
    const avg = calcAvg(raw, countries);
    const prevAvg = prev ? calcAvg(prev.raw_results, countries) : null;
    setHeroStat(`stat-${regionKey}`, `stat-${regionKey}-diff`, avg, prevAvg, 'ìœ„');
  }

  // ìµœê³  ìˆœìœ„ êµ­ê°€
  let bestCountry = null, bestRank = Infinity;
  Object.entries(raw).forEach(([c, d]) => {
    const cr = combinedRank(d.standard, d.deluxe);
    if (cr && cr < bestRank) { bestRank = cr; bestCountry = c; }
  });
  if (bestCountry) {
    document.getElementById('stat-best-flag').textContent = FLAGS[bestCountry] || '?';
    document.getElementById('stat-best-name').textContent = `${bestCountry} Â· ${bestRank}ìœ„`;
  }

  // CHART
  renderChart();

  // HEATMAP
  renderHeatmap(raw, prev?.raw_results);

  // TABLE
  renderTable(currentTab, raw, prev?.raw_results);
}

function setHeroStat(valId, diffId, curr, prev, suffix='') {
  const el = document.getElementById(valId);
  const diffEl = document.getElementById(diffId);
  el.textContent = curr ? `${curr.toFixed(1)}${suffix}` : 'â€”';
  if (diffEl && curr && prev) {
    const d = prev - curr; // ì‘ì„ìˆ˜ë¡ ì¢‹ìœ¼ë‹ˆê¹Œ prev > currì´ë©´ ìƒìŠ¹
    if (d > 0) { diffEl.textContent = `â–² ${d.toFixed(1)} ìƒìŠ¹`; diffEl.className = 'stat-diff up'; }
    else if (d < 0) { diffEl.textContent = `â–¼ ${Math.abs(d).toFixed(1)} í•˜ë½`; diffEl.className = 'stat-diff down'; }
    else { diffEl.textContent = 'ë³€ë™ ì—†ìŒ'; diffEl.className = 'stat-diff'; }
  }
}

// â”€â”€â”€ ë¶‰ì€ì‚¬ë§‰ ì£¼ìš” ì´ë²¤íŠ¸ â”€â”€â”€
const CD_EVENTS = [
  { date: '2026-01-08', label: 'ğŸ“‹ ë¦¬ë·° ì½”ë“œ ë°°í¬ ì–¸ê¸‰',           color: '#9b59b6' },
  { date: '2026-01-29', label: 'ğŸ¥ ì˜¤ë²„ë·° ì˜ìƒ #1 (ì˜¤í”ˆì›”ë“œ)',     color: '#e67e22' },
  { date: '2026-01-21', label: 'ğŸ† ì¶œì‹œì¼Â·ê³¨ë“œë§ˆìŠ¤í„° ê³µì‹ ë°œí‘œ',   color: '#f1c40f' },
  { date: '2026-02-05', label: 'ğŸ¥ ì˜¤ë²„ë·° ì˜ìƒ #2 (ì „íˆ¬ ì‹œìŠ¤í…œ)', color: '#e67e22' },
  { date: '2026-01-28', label: 'ğŸ¤ ìœŒ íŒŒì›ŒìŠ¤ 1v1 ì¸í„°ë·° ì‹œë¦¬ì¦ˆ',  color: '#3498db' },
  { date: '2026-02-12', label: 'ğŸ¥ ì˜¤ë²„ë·° ì˜ìƒ #3 (NPCÂ·í€˜ìŠ¤íŠ¸)', color: '#e67e22' },
  { date: '2026-02-08', label: 'ğŸª IGN Fan Fest ì°¸ê°€ í™•ì¸',        color: '#3498db' },
  { date: '2026-02-14', label: 'ğŸ¤ ìœŒ íŒŒì›ŒìŠ¤ ì¶”ê°€ ì¸í„°ë·°',         color: '#3498db' },
  { date: '2026-02-19', label: 'ğŸ® í•¸ì¦ˆì˜¨ ì´ë²¤íŠ¸Â·ê²Œì„í”Œë ˆì´ ë¦¬ë¹Œ', color: '#2ecc71' },
  { date: '2026-02-25', label: 'ğŸª IGN Fan Fest 2026 ë³¸ í–‰ì‚¬',     color: '#2ecc71' },
  { date: '2026-03-04', label: 'ğŸ¥ í•¸ì¦ˆì˜¨ í”„ë¦¬ë·° ì˜ìƒ ê³µê°œ',       color: '#e67e22' },
  { date: '2026-03-17', label: 'ğŸ“° ë¦¬ë·° ì— ë°”ê³  í•´ì œ(ì¶”ì •)',              color: '#e67e22' },
  { date: '2026-03-19', label: 'ğŸš€ ê¸€ë¡œë²Œ ì¶œì‹œ (ë¶ë¯¸)',            color: '#e74c3c' },
  { date: '2026-03-20', label: 'ğŸš€ í•œêµ­ ì¶œì‹œ',                     color: '#e74c3c' },
];

// â”€â”€â”€ ì´ë²¤íŠ¸ í† ê¸€ ìƒíƒœ â”€â”€â”€
const evState = {}; // { idx: true/false } ê¸°ë³¸ false (êº¼ì§)
const evPanelOpen = { rank: false, sales: false, trends: false };

CD_EVENTS.forEach((_, idx) => { evState[idx] = false; });

function initEvPanels() {
  ['rank', 'sales', 'trends', 'steam'].forEach(chartId => {
    const panel = document.getElementById(`ev-panel-${chartId}`);
    if (!panel) return;
    panel.innerHTML = '';
    CD_EVENTS.forEach((ev, idx) => {
      const btn = document.createElement('button');
      btn.className = 'ev-btn';
      btn.textContent = ev.label;
      btn.style.borderColor = ev.color;
      btn.style.color = ev.color;
      btn.dataset.idx = idx;
      btn.onclick = () => toggleEvent(idx);
      panel.appendChild(btn);
    });
  });
}

function toggleEvPanel(chartId) {
  evPanelOpen[chartId] = !evPanelOpen[chartId];
  const panel = document.getElementById(`ev-panel-${chartId}`);
  const arrow = document.getElementById(`ev-arrow-${chartId}`);
  if (panel) panel.classList.toggle('open', evPanelOpen[chartId]);
  if (arrow) arrow.classList.toggle('open', evPanelOpen[chartId]);
}

function toggleEvent(idx) {
  evState[idx] = !evState[idx];
  // ëª¨ë“  íŒ¨ë„ì˜ ê°™ì€ ì¸ë±ìŠ¤ ë²„íŠ¼ ìƒíƒœ ë™ê¸°í™”
  document.querySelectorAll(`.ev-btn[data-idx="${idx}"]`).forEach(btn => {
    btn.classList.toggle('active', evState[idx]);
  });
  // ì„¸ ì°¨íŠ¸ ëª¨ë‘ annotation ê°±ì‹ 
  updateAllAnnotations();
}

function buildEventAnnotations() {
  const annotations = {};
  const positions = ['5%', '18%', '31%', '44%', '57%', '70%', '83%'];
  CD_EVENTS.forEach((ev, idx) => {
    if (!evState[idx]) return; // êº¼ì§„ ì´ë²¤íŠ¸ëŠ” ì œì™¸
    annotations[`ev${idx}`] = {
      type: 'line',
      xMin: ev.date,
      xMax: ev.date,
      borderColor: ev.color,
      borderWidth: 1.5,
      borderDash: [4, 3],
      label: {
        display: true,
        content: ev.label,
        position: positions[idx % positions.length],
        backgroundColor: 'rgba(26,19,24,0.85)',
        color: ev.color,
        font: { size: 9, weight: 'bold' },
        padding: { x: 5, y: 3 },
        borderRadius: 3,
      }
    };
  });
  return annotations;
}

function updateAllAnnotations() {
  const anns = buildEventAnnotations();
  [chartInstance, salesChartInstance, trendsChartInstance, steamChartInstance].forEach(chart => {
    if (!chart) return;
    chart.options.plugins.annotation.annotations = anns;
    chart.update('none');
  });
}


function renderChart() {
  // {x: Date, y: rank} í˜•íƒœë¡œ ë³€í™˜ (time scaleìš©)
  const dataPoints = allHistory
    .filter(h => h.averages?.combined != null)
    .map(h => ({ x: new Date(h.timestamp), y: h.averages.combined }));

  const ctx = document.getElementById('rankChart').getContext('2d');
  if (chartInstance) chartInstance.destroy();

  chartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      datasets: [{
        label: 'ê°€ì¤‘ í‰ê·  ìˆœìœ„',
        data: dataPoints,
        borderColor: '#c0392b',
        backgroundColor: (ctx2) => {
          const g = ctx2.chart.ctx.createLinearGradient(0, 0, 0, 220);
          g.addColorStop(0, 'rgba(192,57,43,0.25)');
          g.addColorStop(1, 'rgba(192,57,43,0)');
          return g;
        },
        borderWidth: 2,
        pointBackgroundColor: '#e74c3c',
        pointRadius: dataPoints.length > 30 ? 0 : 4,
        pointHoverRadius: 6,
        tension: 0.4,
        fill: true,
        spanGaps: true,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          reverse: true,
          ticks: { color: '#7a6a65', font: { size: 11 } },
          grid: { color: 'rgba(42,31,34,0.8)' },
          border: { color: '#2a1f22' }
        },
        x: {
          type: 'time',
          time: { unit: 'day', displayFormats: { day: 'M/d' } },
          ticks: { color: '#7a6a65', font: { size: 10 }, maxTicksLimit: 20, maxRotation: 45, source: 'auto' },
          grid: { display: false },
          border: { color: '#2a1f22' }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#1a1318',
          borderColor: '#2a1f22',
          borderWidth: 1,
          titleColor: '#e8ddd5',
          bodyColor: '#c0392b',
          callbacks: {
            title: items => {
              const d = new Date(items[0].parsed.x);
              return `${d.getMonth()+1}/${d.getDate()}`;
            },
            label: ctx2 => `ê°€ì¤‘ í‰ê· : ${ctx2.parsed.y?.toFixed(1) ?? 'â€”'}ìœ„`
          }
        },
        annotation: {
          annotations: buildEventAnnotations()
        }
      }
    }
  });
}


// â”€â”€â”€ êµ­ê¸° ì»¨íŠ¸ë¡¤ â”€â”€â”€
let flagEnabled = true;
let flagOpacity = 0.52;

function toggleFlag() {
  flagEnabled = !flagEnabled;
  const btn = document.getElementById('flag-toggle-btn');
  const opacityWrap = document.getElementById('flag-opacity-wrap');
  btn.textContent = flagEnabled ? 'ğŸ³ êµ­ê¸° ON' : 'ğŸ³ êµ­ê¸° OFF';
  btn.classList.toggle('active', flagEnabled);
  opacityWrap.style.opacity = flagEnabled ? '1' : '0.3';
  opacityWrap.style.pointerEvents = flagEnabled ? '' : 'none';
  refreshHeatmap();
}

function updateFlagOpacity(val) {
  flagOpacity = val / 100;
  refreshHeatmap();
}

function refreshHeatmap() {
  if (!allHistory.length) return;
  const latest = allHistory[allHistory.length - 1];
  const prev   = allHistory.length >= 2 ? allHistory[allHistory.length - 2] : null;
  renderHeatmap(latest.raw_results, prev?.raw_results);
}

function renderHeatmap(raw, prevRaw) {
  const grid = document.getElementById('heatmap-grid');
  const allCountries = Object.values(REGIONS).flat();
  
  // ìˆœìœ„ ê¸°ì¤€ ì •ë ¬ (ìˆœìœ„ ì—†ëŠ” ê±´ ë’¤ë¡œ)
  const sorted = allCountries.slice().sort((a, b) => {
    const ra = combinedRank(raw[a]?.standard, raw[a]?.deluxe) ?? 9999;
    const rb = combinedRank(raw[b]?.standard, raw[b]?.deluxe) ?? 9999;
    if (ra !== rb) return ra - rb;
    return (MARKET_WEIGHTS[b] || 0) - (MARKET_WEIGHTS[a] || 0);
  });

  // ìˆœìœ„ë³„ ê·¸ë£¹í•‘
  const rankGroups = {};
  sorted.forEach(c => {
    const d = raw[c] || {};
    const cr = combinedRank(d.standard, d.deluxe);
    const key = cr ?? 'none';
    if (!rankGroups[key]) rankGroups[key] = [];
    rankGroups[key].push(c);
  });

  const rankKeys = Object.keys(rankGroups).sort((a, b) => {
    if (a === 'none') return 1;
    if (b === 'none') return -1;
    return Number(a) - Number(b);
  });

  function fmtDiff(curr, prev) {
    if (curr == null || prev == null) return '';
    const d = prev - curr;
    if (d > 0) return `<span style="color:#2ecc71">+${d}</span>`;
    if (d < 0) return `<span style="color:#e74c3c">${d}</span>`;
    return '';
  }

  grid.innerHTML = rankKeys.map(key => {
    const cards = rankGroups[key].map(c => {
      const d   = raw[c]     || {};
      const pd  = prevRaw?.[c] || {};
      const cr  = combinedRank(d.standard, d.deluxe);
      const pcr = combinedRank(pd.standard, pd.deluxe);

      const cDiffHtml = fmtDiff(cr, pcr);
      const countryHtml = cDiffHtml
        ? `${c}&nbsp;<span class="hm-cdiff">(${cDiffHtml})</span>`
        : c;

      let editionLine = '';
      if (d.standard && d.deluxe) {
        if (cr === d.standard) {
          const eDiff = fmtDiff(d.deluxe, pd.deluxe);
          editionLine = eDiff
            ? `${d.deluxe}ìœ„ (D, ${fmtDiff(d.deluxe, pd.deluxe)}ìœ„)`
            : `${d.deluxe}ìœ„ (D)`;
        } else {
          const eDiff = fmtDiff(d.standard, pd.standard);
          editionLine = eDiff
            ? `${d.standard}ìœ„ (S, ${fmtDiff(d.standard, pd.standard)}ìœ„)`
            : `${d.standard}ìœ„ (S)`;
        }
      } else if (d.standard && !d.deluxe) {
        editionLine = `(S only)`;
      } else if (!d.standard && d.deluxe) {
        editionLine = `(D only)`;
      }

      const diff = cr && pcr ? pcr - cr : 0;
      const arrowColor = diff > 0 ? '#2ecc71' : diff < 0 ? '#e74c3c' : 'transparent';
      const flagUrl = flagEnabled ? getFlagUrl(c) : null;
      const flagBg = flagUrl
        ? `background-image:url(${flagUrl});background-size:cover;background-position:center;`
        : 'background:#1a1318;';
      const overlayAlpha = flagEnabled ? flagOpacity.toFixed(2) : 0;

      return `
        <div class="heatmap-card" style="${flagBg}" title="${c}: S${d.standard ?? '-'} / D${d.deluxe ?? '-'}" onclick="openCountryModal('${c}')">
          <div style="position:absolute;inset:0;background:rgba(0,0,0,${overlayAlpha});border-radius:inherit;pointer-events:none"></div>
          <div style="position:absolute;left:0;top:0;bottom:0;width:3px;background:${arrowColor}"></div>
          <div style="position:relative">
            <div class="hm-country">${countryHtml}</div>
            ${editionLine ? `<div class="hm-edition">${editionLine}</div>` : ''}
          </div>
        </div>`;
    }).join('');

    return `<div class="heatmap-rank-row">
      <div class="heatmap-rank-label">${key !== 'none' ? key + 'ìœ„' : 'â€”'}</div>
      <div class="heatmap-cards-wrap">${cards}</div>
    </div>`;
  }).join('');
}

let currentSortKey = 'weight';
let currentSortDir = 'desc';

function setSort(key) {
  if (currentSortKey === key) {
    currentSortDir = currentSortDir === 'asc' ? 'desc' : 'asc';
  } else {
    currentSortKey = key;
    currentSortDir = key === 'name' ? 'asc' : 'asc';
  }
  // ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
  ['name','standard','deluxe','combined','weight'].forEach(k => {
    const el = document.getElementById('sort-icon-' + k);
    if (!el) return;
    el.className = 'sort-icon';
    if (k === currentSortKey) el.classList.add(currentSortDir);
  });
  if (allHistory.length) {
    const latest = allHistory[allHistory.length - 1];
    const prev   = allHistory.length >= 2 ? allHistory[allHistory.length - 2] : null;
    renderTable(currentTab, latest.raw_results, prev?.raw_results);
  }
}

function renderTable(tab, raw, prevRaw) {
  const tbody = document.getElementById('rank-table');

  let countries;
  if (tab === 'all') {
    countries = Object.values(REGIONS).flat();
  } else if (tab === 'americas') {
    countries = REGIONS['Americas'];
  } else if (tab === 'europe') {
    countries = REGIONS['Europe & Middle East'];
  } else {
    countries = REGIONS['Asia & Oceania'];
  }

  // ì •ë ¬
  const sorted = countries.slice().sort((a, b) => {
    const da = raw[a] || {}, db = raw[b] || {};
    const crA = combinedRank(da.standard, da.deluxe);
    const crB = combinedRank(db.standard, db.deluxe);
    let valA, valB;
    if (currentSortKey === 'name') {
      valA = a; valB = b;
      return currentSortDir === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
    } else if (currentSortKey === 'standard') {
      valA = da.standard ?? 9999; valB = db.standard ?? 9999;
    } else if (currentSortKey === 'deluxe') {
      valA = da.deluxe ?? 9999; valB = db.deluxe ?? 9999;
    } else if (currentSortKey === 'combined') {
      valA = crA ?? 9999; valB = crB ?? 9999;
    } else {
      valA = MARKET_WEIGHTS[a] || 0; valB = MARKET_WEIGHTS[b] || 0;
    }
    return currentSortDir === 'asc' ? valA - valB : valB - valA;
  });

  tbody.innerHTML = sorted.map((c, i) => {
    const d = raw[c] || {};
    const pd = prevRaw?.[c] || {};
    const cr = combinedRank(d.standard, d.deluxe);
    const prevCr = combinedRank(pd.standard, pd.deluxe);
    const url = URLS[c];
    const nameLink = url
      ? `<a href="${url}" target="_blank" style="color:var(--text);text-decoration:none">${c}</a>`
      : c;

    return `
      <tr class="row-enter" style="animation-delay:${i * 0.02}s">
        <td>
          <div class="country-cell">
            <span class="flag">${FLAGS[c] || ''}</span>
            <span class="country-name">${nameLink}</span>
          </div>
        </td>
        <td>
          <span class="rank-val ${d.standard ? '' : 'no-data'}" style="color:${rankTextColor(d.standard)}">${d.standard ? `${d.standard}ìœ„` : 'â€”'}</span>
          ${diffBadge(d.standard, pd.standard)}
        </td>
        <td>
          <span class="rank-val ${d.deluxe ? '' : 'no-data'}" style="color:${rankTextColor(d.deluxe)}">${d.deluxe ? `${d.deluxe}ìœ„` : 'â€”'}</span>
          ${diffBadge(d.deluxe, pd.deluxe)}
        </td>
        <td class="combined-cell">
          <span class="rank-val ${cr ? '' : 'no-data'}" style="color:${rankTextColor(cr)}">${cr ? `${cr}ìœ„` : 'â€”'}</span>
          ${diffBadge(cr, prevCr)}
        </td>
        <td><span class="weight-badge">${(MARKET_WEIGHTS[c] || 0).toFixed(1)}</span></td>
      </tr>`;
  }).join('');
}

function switchTab(tab, btn) {
  currentTab = tab;
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  if (allHistory.length) {
    const latest = allHistory[allHistory.length - 1];
    const prev   = allHistory.length >= 2 ? allHistory[allHistory.length - 2] : null;
    renderTable(tab, latest.raw_results, prev?.raw_results);
  }
}

// â”€â”€â”€ íŒë§¤ëŸ‰ ì¶”ì‚° â”€â”€â”€
let salesChartInstance = null;
let salesMode = 'daily';
let salesDailyData = []; // { dateStr, date, std, dlx, tot, isHistorical }

// Pythonì˜ rank_to_daily_sales ë™ì¼ ë¡œì§
const _A1=600, _A20=70, _A100=15;
const _k1 = Math.log(_A1/_A20)/(20-1);
const _k2 = Math.log(_A20/_A100)/(100-20);

function rankToSales(rank) {
  if (!rank) return 0;
  const r = parseInt(rank);
  return r <= 20
    ? _A1 * Math.exp(-_k1 * (r - 1))
    : _A20 * Math.exp(-_k2 * (r - 20));
}

// Pythonì˜ PS_MARKET_MULTIPLIER (_US_BASE=30, Ã—10/30)
const SALES_MULTIPLIER = (() => {
  const base = 30.0;
  const w = MARKET_WEIGHTS; // ì´ë¯¸ ì •ì˜ëœ MARKET_WEIGHTS ì¬ì‚¬ìš©
  const m = {};
  for (const [c, v] of Object.entries(w)) m[c] = v / base * 10;
  return m;
})();

function getMultiplier(country) {
  return SALES_MULTIPLIER[country] ?? 0.10;
}

async function loadHistoricalData() {
  try {
    const res = await fetch('historical_ranking_data.json?t=' + Date.now());
    if (!res.ok) return [];
    return await res.json();
  } catch { return []; }
}

async function renderSalesEstimate() {
  if (!allHistory.length) return;

  const historical = await loadHistoricalData();

  // â”€â”€ ì‹¤ì œ ë°ì´í„°: rank_history.jsonì—ì„œ ì¼ë³„ ì§‘ê³„ â”€â”€
  const realByDate = {};
  for (const entry of allHistory) {
    const d = new Date(entry.timestamp);
    const ds = d.toISOString().slice(0,10);
    if (!realByDate[ds]) realByDate[ds] = [];
    realByDate[ds].push(entry.raw_results);
  }

  const realDays = [];
  for (const [ds, entries] of Object.entries(realByDate).sort()) {
    // ê° ë‚ ì§œì—ì„œ êµ­ê°€ë³„ ìµœê³  ìˆœìœ„(ê°€ì¥ ë‚®ì€ ìˆ«ì) ì„ íƒ
    const best = {};
    for (const raw of entries) {
      for (const [c, d] of Object.entries(raw)) {
        if (!best[c]) best[c] = { standard: null, deluxe: null };
        if (d.standard && (!best[c].standard || d.standard < best[c].standard)) best[c].standard = d.standard;
        if (d.deluxe   && (!best[c].deluxe   || d.deluxe   < best[c].deluxe  )) best[c].deluxe   = d.deluxe;
      }
    }
    let std=0, dlx=0;
    for (const [c, r] of Object.entries(best)) {
      const m = getMultiplier(c);
      if (r.standard) std += rankToSales(r.standard) * m;
      if (r.deluxe)   dlx += rankToSales(r.deluxe)   * m;
    }
    realDays.push({ dateStr: ds, date: new Date(ds+'T12:00:00'), std: Math.round(std), dlx: Math.round(dlx), tot: Math.round(std+dlx), isHistorical: false });
  }

  // â”€â”€ ê³¼ê±° ë°ì´í„°: historical_ranking_data.json â”€â”€
  // ì‹¤ì œ ë°ì´í„°ì˜ ì²« ë‚ ì§œ ì´ì „ ê²ƒë§Œ ì‚¬ìš©
  const realFirstDate = realDays.length ? realDays[0].dateStr : '9999-12-31';

  // ì‹¤ì œ ë°ì´í„°ì—ì„œ std/dlx í‰ê·  ê°­ ê³„ì‚°
  let sumStd=0, sumDlx=0, cnt=0;
  for (const entry of allHistory) {
    for (const d of Object.values(entry.raw_results)) {
      if (d.standard) { sumStd += d.standard; cnt++; }
      if (d.deluxe)   { sumDlx += d.deluxe; }
    }
  }
  const avgStd = cnt ? sumStd/cnt : 15;
  const avgDlx = cnt ? sumDlx/cnt : 8;
  const rankGap = avgStd - avgDlx;

  const countries = Object.keys(allHistory[0]?.raw_results || {});

  const histDays = [];
  for (const item of historical) {
    if (item.date >= realFirstDate) continue;
    const avgRank = item.average_rank ?? 15;
    const countryRanks = item.country_ranks || {};

    let std=0, dlx=0;
    for (const c of countries) {
      const base = countryRanks[c] ?? avgRank;
      const stdR = Math.max(1, Math.round(base + rankGap/2));
      const dlxR = Math.max(1, Math.round(base - rankGap/2));
      const m = getMultiplier(c);
      std += rankToSales(stdR) * m;
      dlx += rankToSales(dlxR) * m;
    }
    histDays.push({ dateStr: item.date, date: new Date(item.date+'T12:00:00'), std: Math.round(std), dlx: Math.round(dlx), tot: Math.round(std+dlx), isHistorical: true });
  }

  salesDailyData = [...histDays, ...realDays];

  // â”€â”€ ì˜¤ëŠ˜ ìŠ¤íƒ¯ í‘œì‹œ â”€â”€
  const today = realDays[realDays.length - 1];
  if (today) {
    document.getElementById('sales-today-std').textContent = today.std.toLocaleString();
    document.getElementById('sales-today-dlx').textContent = today.dlx.toLocaleString();
    document.getElementById('sales-today-tot').textContent = today.tot.toLocaleString();
  }

  // ëˆ„ì  í•©ê³„
  const cumTotal = salesDailyData.reduce((s, d) => s + d.tot, 0);
  document.getElementById('sales-cumulative').textContent = cumTotal.toLocaleString();
  if (salesDailyData.length) {
    document.getElementById('sales-cumulative-range').textContent =
      `${salesDailyData[0].dateStr} ~ ${salesDailyData[salesDailyData.length-1].dateStr}`;
  }

  renderSalesChart();
}

function renderSalesChart() {
  if (!salesDailyData.length) return;

  const ctx = document.getElementById('salesChart').getContext('2d');
  if (salesChartInstance) salesChartInstance.destroy();

  // time scaleìš© {x: Date, y: value} ë³€í™˜ í—¬í¼
  const toXY = (arr) => arr.map((v, i) => ({ x: salesDailyData[i].date, y: v }));

  let datasets;
  if (salesMode === 'daily') {
    const histStd = salesDailyData.map(d => d.isHistorical ? d.std : null);
    const histDlx = salesDailyData.map(d => d.isHistorical ? d.dlx : null);
    const realStd = salesDailyData.map(d => !d.isHistorical ? d.std : null);
    const realDlx = salesDailyData.map(d => !d.isHistorical ? d.dlx : null);

    datasets = [
      { label:'ìŠ¤íƒ ë‹¤ë“œ (ì¶”ì •)', data: toXY(histStd), borderColor:'#90CAF9', backgroundColor:'rgba(46,134,171,0.06)', borderWidth:1.5, borderDash:[5,4], pointRadius:0, tension:0.4, spanGaps:false, fill:true },
      { label:'ë””ëŸ­ìŠ¤ (ì¶”ì •)',   data: toXY(histDlx), borderColor:'#F48FB1', backgroundColor:'rgba(162,59,114,0.06)', borderWidth:1.5, borderDash:[5,4], pointRadius:0, tension:0.4, spanGaps:false, fill:true },
      { label:'ìŠ¤íƒ ë‹¤ë“œ (ì‹¤ì œ)', data: toXY(realStd), borderColor:'#2E86AB', backgroundColor:'rgba(46,134,171,0.1)',  borderWidth:2,   pointRadius: salesDailyData.length>60?0:3, tension:0.4, spanGaps:false, fill:true },
      { label:'ë””ëŸ­ìŠ¤ (ì‹¤ì œ)',   data: toXY(realDlx), borderColor:'#A23B72', backgroundColor:'rgba(162,59,114,0.1)', borderWidth:2,   pointRadius: salesDailyData.length>60?0:3, tension:0.4, spanGaps:false, fill:true },
    ];
  } else {
    let cumStdH=0, cumDlxH=0, cumStdR=0, cumDlxR=0;
    const cumHistStd=[], cumHistDlx=[], cumRealStd=[], cumRealDlx=[];
    let switchIdx = -1;
    for (let i=0; i<salesDailyData.length; i++) {
      const d = salesDailyData[i];
      if (d.isHistorical) {
        cumStdH += d.std; cumDlxH += d.dlx;
        cumHistStd.push(cumStdH); cumHistDlx.push(cumDlxH);
        cumRealStd.push(null);    cumRealDlx.push(null);
      } else {
        if (switchIdx < 0) { switchIdx = i; cumStdR = cumStdH; cumDlxR = cumDlxH; }
        cumStdR += d.std; cumDlxR += d.dlx;
        cumRealStd.push(cumStdR); cumRealDlx.push(cumDlxR);
        cumHistStd.push(null);    cumHistDlx.push(null);
      }
    }
    const cumHistTot = cumHistStd.map((s,i) => s!=null&&cumHistDlx[i]!=null ? s+cumHistDlx[i] : null);
    const cumRealTot = cumRealStd.map((s,i) => s!=null&&cumRealDlx[i]!=null ? s+cumRealDlx[i] : null);

    datasets = [
      { label:'ëˆ„ì  ìŠ¤íƒ ë‹¤ë“œ (ì¶”ì •)', data:toXY(cumHistStd), borderColor:'#90CAF9', borderWidth:1.5, borderDash:[5,4], pointRadius:0, tension:0.4, spanGaps:false, fill:false },
      { label:'ëˆ„ì  ë””ëŸ­ìŠ¤ (ì¶”ì •)',   data:toXY(cumHistDlx), borderColor:'#F48FB1', borderWidth:1.5, borderDash:[5,4], pointRadius:0, tension:0.4, spanGaps:false, fill:false },
      { label:'ëˆ„ì  í•©ê³„ (ì¶”ì •)',     data:toXY(cumHistTot), borderColor:'#A8D5A2', borderWidth:1.5, borderDash:[5,4], pointRadius:0, tension:0.4, spanGaps:false, fill:false },
      { label:'ëˆ„ì  ìŠ¤íƒ ë‹¤ë“œ (ì‹¤ì œ)', data:toXY(cumRealStd), borderColor:'#2E86AB', borderWidth:2,   pointRadius:0, tension:0.4, spanGaps:false, fill:false },
      { label:'ëˆ„ì  ë””ëŸ­ìŠ¤ (ì‹¤ì œ)',   data:toXY(cumRealDlx), borderColor:'#A23B72', borderWidth:2,   pointRadius:0, tension:0.4, spanGaps:false, fill:false },
      { label:'ëˆ„ì  í•©ê³„ (ì‹¤ì œ)',     data:toXY(cumRealTot), borderColor:'#27AE60', borderWidth:2.5, pointRadius:0, tension:0.4, spanGaps:false, fill:false },
    ];
  }

  salesChartInstance = new Chart(ctx, {
    type: 'line',
    data: { datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      scales: {
        y: {
          ticks: { color:'#7a6a65', font:{size:11}, callback: v => v>=1000 ? (v/1000).toFixed(1)+'k' : v },
          grid:  { color:'rgba(42,31,34,0.8)' },
          border: { color:'#2a1f22' }
        },
        x: {
          type: 'time',
          time: { unit: 'day', displayFormats: { day: 'M/d' } },
          ticks: { color:'#7a6a65', font:{size:10}, maxTicksLimit:20, maxRotation:45 },
          grid:  { display:false },
          border: { color:'#2a1f22' }
        }
      },
      plugins: {
        legend: { display:true, labels:{ color:'#e8ddd5', font:{size:10}, boxWidth:10, padding:12 } },
        tooltip: {
          backgroundColor:'#1a1318', borderColor:'#2a1f22', borderWidth:1,
          titleColor:'#e8ddd5', bodyColor:'#e8ddd5',
          callbacks: { label: ctx2 => ctx2.parsed.y != null ? `${ctx2.dataset.label}: ${Math.round(ctx2.parsed.y).toLocaleString()} units` : null }
        },
        annotation: { annotations: buildEventAnnotations() }
      }
    }
  });
}

function switchSalesTab(mode, btn) {
  salesMode = mode;
  document.querySelectorAll('.sales-tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderSalesChart();
}

// â”€â”€â”€ êµ¬ê¸€ íŠ¸ë Œë“œ â”€â”€â”€
let trendsChartInstance = null;

const CONSOLE_COUNTRY_FLAGS = {
  'United States': 'ğŸ‡ºğŸ‡¸',
  'Japan':         'ğŸ‡¯ğŸ‡µ',
  'United Kingdom':'ğŸ‡¬ğŸ‡§',
  'Germany':       'ğŸ‡©ğŸ‡ª',
  'France':        'ğŸ‡«ğŸ‡·',
};

async function loadTrendsData() {
  try {
    const res = await fetch('trends_history.json?t=' + Date.now());
    if (!res.ok) return;
    const data = await res.json();
    if (!data.length) return;
    renderTrends(data);
  } catch (e) {
    console.warn('trends_history.json ë¡œë“œ ì‹¤íŒ¨:', e);
  }
}

function renderTrends(data) {
  // google ë°ì´í„° ìˆëŠ” í•­ëª©ë§Œ
  const gEntries = data.filter(e => e.google?.score != null);
  if (!gEntries.length) return;

  const latest  = gEntries[gEntries.length - 1];
  const prev    = gEntries.length >= 2 ? gEntries[gEntries.length - 2] : null;
  const scores  = gEntries.map(e => e.google.score);
  const peak    = Math.max(...scores);
  const peakEntry = gEntries[scores.indexOf(peak)];
  const avg     = Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);

  // Google í˜„ì¬
  const gNow = latest.google.score;
  document.getElementById('trends-google-now').textContent = gNow;
  const gDiffEl = document.getElementById('trends-google-diff');
  if (prev?.google?.score != null) {
    const d = gNow - prev.google.score;
    gDiffEl.textContent = d > 0 ? `â–² ${d} ìƒìŠ¹` : d < 0 ? `â–¼ ${Math.abs(d)} í•˜ë½` : 'ë³€ë™ ì—†ìŒ';
    gDiffEl.style.color = d > 0 ? 'var(--up)' : d < 0 ? 'var(--down)' : 'var(--muted)';
  } else {
    gDiffEl.textContent = '/ 100';
  }

  // í‰ê·  / ìµœê³ 
  document.getElementById('trends-google-avg').textContent  = avg;
  document.getElementById('trends-google-peak').textContent = peak;
  document.getElementById('trends-google-peak-date').textContent = fmtDate(peakEntry.timestamp);

  // â”€â”€ ì°¨íŠ¸ â”€â”€
  const labels = gEntries.map(e => {
    const d = new Date(e.timestamp);
    return `${d.getMonth()+1}/${d.getDate()}`;
  });
  const gScores  = gEntries.map(e => e.google.score);

  const ctx = document.getElementById('trendsChart').getContext('2d');
  if (trendsChartInstance) trendsChartInstance.destroy();

  trendsChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      datasets: [
        {
          label: 'Google ê¸€ë¡œë²Œ',
          data: gEntries.map(e => ({ x: new Date(e.timestamp), y: e.google.score })),
          borderColor: '#4285F4',
          backgroundColor: 'rgba(66,133,244,0.08)',
          borderWidth: 2,
          pointRadius: gEntries.length > 60 ? 0 : 3,
          pointHoverRadius: 5,
          tension: 0.4,
          fill: true,
          spanGaps: true,
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          min: 0, max: 105,
          ticks: { color: '#7a6a65', font: { size: 11 } },
          grid:  { color: 'rgba(42,31,34,0.8)' },
          border: { color: '#2a1f22' }
        },
        x: {
          type: 'time',
          time: { unit: 'day', displayFormats: { day: 'M/d' } },
          ticks: { color: '#7a6a65', font: { size: 10 }, maxTicksLimit: 20, maxRotation: 45 },
          grid:  { display: false },
          border: { color: '#2a1f22' }
        }
      },
      plugins: {
        legend: { display: true, labels: { color: '#e8ddd5', font: { size: 11 }, boxWidth: 10, padding: 14 } },
        tooltip: {
          backgroundColor: '#1a1318', borderColor: '#2a1f22', borderWidth: 1,
          titleColor: '#e8ddd5', bodyColor: '#e8ddd5',
          callbacks: { label: ctx2 => ctx2.parsed.y != null ? `${ctx2.dataset.label}: ${ctx2.parsed.y}/100` : null }
        },
        annotation: { annotations: buildEventAnnotations() }
      }
    }
  });

  // â”€â”€ êµ­ê°€ë³„ ì¹´ë“œ â”€â”€
  // console_markets ìˆëŠ” í•­ëª© ì¤‘ ê°€ì¥ ìµœê·¼
  const consoleEntry = [...data].reverse().find(e => e.console_markets && Object.keys(e.console_markets).length > 0);
  const grid = document.getElementById('trends-countries-grid');
  grid.innerHTML = '';
  if (consoleEntry) {
    for (const [country, info] of Object.entries(consoleEntry.console_markets)) {
      if (!info) continue;
      const score = info.score ?? 0;
      const avg1m = info.avg_1m ?? 0;
      const flag  = CONSOLE_COUNTRY_FLAGS[country] || 'ğŸŒ';
      const barColor = score >= 70 ? '#4285F4' : score >= 40 ? '#FBBC05' : '#EA4335';
      grid.innerHTML += `
        <div class="trends-country-card">
          <span class="trends-country-flag">${flag}</span>
          <div class="trends-country-info">
            <div class="trends-country-name">${country}</div>
            <div class="trends-country-score" style="color:${barColor}">${score}<span style="font-size:0.7rem;color:var(--muted)">/100</span></div>
            <div class="trends-score-bar"><div class="trends-score-fill" style="width:${score}%;background:${barColor}"></div></div>
            <div style="font-size:0.62rem;color:var(--muted);margin-top:2px">1ê°œì›” í‰ê·  ${avg1m}/100</div>
          </div>
        </div>`;
    }
  }
}

// â”€â”€â”€ STEAM ë°ì´í„° â”€â”€â”€
let steamHistory = [];
let steamChartInstance = null;

async function loadSteamData() {
  try {
    const res = await fetch('steam_history.json?t=' + Date.now());
    if (!res.ok) throw new Error('steam fetch failed');
    steamHistory = await res.json();
    renderSteam();
  } catch (e) {
    console.warn('steam_history.json ë¡œë“œ ì‹¤íŒ¨:', e);
    // Steam ì„¹ì…˜ ìˆ¨ê¸°ì§€ ì•Šê³  â€” í‘œì‹œ ìœ ì§€
  }
}

function renderSteam() {
  if (!steamHistory.length) return;

  const valid = steamHistory.filter(h => h.rank != null);
  if (!valid.length) return;

  const latest   = valid[valid.length - 1];
  const prev     = valid.length >= 2 ? valid[valid.length - 2] : null;
  const best     = valid.reduce((a, b) => a.rank <= b.rank ? a : b);
  const first    = valid[0];

  // í˜„ì¬ ìˆœìœ„
  const rankEl = document.getElementById('steam-rank-current');
  const diffEl = document.getElementById('steam-rank-diff');
  rankEl.textContent = `#${latest.rank}`;
  if (prev) {
    const d = prev.rank - latest.rank;
    if (d > 0)      { diffEl.textContent = `â–² ${d} ìƒìŠ¹`; diffEl.className = 'steam-stat-diff up'; }
    else if (d < 0) { diffEl.textContent = `â–¼ ${Math.abs(d)} í•˜ë½`; diffEl.className = 'steam-stat-diff down'; }
    else            { diffEl.textContent = 'ë³€ë™ ì—†ìŒ'; diffEl.className = 'steam-stat-diff'; }
  }

  // ìµœê³  ìˆœìœ„
  document.getElementById('steam-rank-best').textContent = `#${best.rank}`;
  document.getElementById('steam-rank-best-date').textContent = fmtDate(best.timestamp);

  // ì¶”ì  ì‹œì‘ ìˆœìœ„
  document.getElementById('steam-rank-first').textContent = `#${first.rank}`;
  document.getElementById('steam-rank-first-date').textContent = fmtDate(first.timestamp);

  // ì´ ê¸°ë¡ ìˆ˜
  document.getElementById('steam-count').textContent = steamHistory.length;

  // ì°¨íŠ¸
  const rankData = steamHistory.map(h => ({ x: new Date(h.timestamp), y: h.rank }));

  const ctx = document.getElementById('steamChart').getContext('2d');
  if (steamChartInstance) steamChartInstance.destroy();

  steamChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      datasets: [{
        label: 'Steam ìœ„ì‹œë¦¬ìŠ¤íŠ¸ ìˆœìœ„',
        data: rankData,
        borderColor: '#4fc3f7',
        backgroundColor: (ctx2) => {
          const g = ctx2.chart.ctx.createLinearGradient(0, 0, 0, 200);
          g.addColorStop(0, 'rgba(79,195,247,0.2)');
          g.addColorStop(1, 'rgba(79,195,247,0)');
          return g;
        },
        borderWidth: 2,
        pointBackgroundColor: '#4fc3f7',
        pointRadius: rankData.length > 50 ? 0 : 3,
        pointHoverRadius: 5,
        tension: 0.4,
        fill: true,
        spanGaps: true,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          reverse: true,
          ticks: { color: '#7a6a65', font: { size: 11 }, stepSize: 1 },
          grid:  { color: 'rgba(42,31,34,0.8)' },
          border: { color: '#2a1f22' }
        },
        x: {
          type: 'time',
          time: { unit: 'day', displayFormats: { day: 'M/d' } },
          ticks: { color: '#7a6a65', font: { size: 10 }, maxTicksLimit: 20, maxRotation: 45 },
          grid: { display: false },
          border: { color: '#2a1f22' }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#1a1318',
          borderColor: '#2a1f22',
          borderWidth: 1,
          titleColor: '#e8ddd5',
          bodyColor: '#4fc3f7',
          callbacks: {
            label: ctx2 => ctx2.parsed.y != null ? `ìœ„ì‹œë¦¬ìŠ¤íŠ¸ ìˆœìœ„: #${ctx2.parsed.y}` : 'ë°ì´í„° ì—†ìŒ'
          }
        },
        annotation: { annotations: buildEventAnnotations() }
      }
    }
  });
}

function fmtDate(iso) {
  const d = new Date(iso);
  return `${d.getFullYear()}.${d.getMonth()+1}.${d.getDate()}`;
}

// â”€â”€â”€ êµ­ê°€ ëª¨ë‹¬ â”€â”€â”€
let modalChartInstance = null;

function openCountryModal(country) {
  if (!allHistory.length) return;

  const latest = allHistory[allHistory.length - 1];
  const prev   = allHistory.length >= 2 ? allHistory[allHistory.length - 2] : null;
  const raw    = latest.raw_results;
  const prevRaw = prev?.raw_results;

  const d  = raw[country]    || {};
  const pd = prevRaw?.[country] || {};
  const cr  = combinedRank(d.standard, d.deluxe);
  const pcr = combinedRank(pd.standard, pd.deluxe);

  // í—¤ë”
  document.getElementById('modal-flag').textContent  = FLAGS[country] || 'ğŸ³ï¸';
  document.getElementById('modal-name').textContent  = country;

  // ìŠ¤íƒ¯
  setModalStat('modal-standard', 'modal-standard-diff', d.standard, pd.standard);
  setModalStat('modal-deluxe',   'modal-deluxe-diff',   d.deluxe,   pd.deluxe);
  setModalStat('modal-combined', 'modal-combined-diff', cr,          pcr);

  // ì°¨íŠ¸
  const labels = allHistory.map(h => {
    const dt = new Date(h.timestamp);
    return `${dt.getMonth()+1}/${dt.getDate()}`;
  });
  const stdData = allHistory.map(h => h.raw_results?.[country]?.standard ?? null);
  const dlxData = allHistory.map(h => h.raw_results?.[country]?.deluxe   ?? null);

  const ctx = document.getElementById('modalChart').getContext('2d');
  if (modalChartInstance) modalChartInstance.destroy();

  modalChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'ìŠ¤íƒ ë‹¤ë“œ',
          data: stdData,
          borderColor: '#e74c3c',
          backgroundColor: 'rgba(231,76,60,0.08)',
          borderWidth: 2,
          pointRadius: stdData.length > 30 ? 0 : 3,
          pointHoverRadius: 5,
          tension: 0.4,
          fill: true,
          spanGaps: true,
        },
        {
          label: 'ë””ëŸ­ìŠ¤',
          data: dlxData,
          borderColor: '#d4a017',
          backgroundColor: 'rgba(212,160,23,0.08)',
          borderWidth: 2,
          pointRadius: dlxData.length > 30 ? 0 : 3,
          pointHoverRadius: 5,
          tension: 0.4,
          fill: true,
          spanGaps: true,
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          reverse: true,
          ticks: { color: '#7a6a65', font: { size: 11 }, stepSize: 1 },
          grid:  { color: 'rgba(42,31,34,0.8)' },
          border: { color: '#2a1f22' }
        },
        x: {
          ticks: { color: '#7a6a65', font: { size: 10 }, maxTicksLimit: 10, maxRotation: 0 },
          grid:  { display: false },
          border: { color: '#2a1f22' }
        }
      },
      plugins: {
        legend: {
          display: true,
          labels: { color: '#e8ddd5', font: { size: 11 }, boxWidth: 12, padding: 16 }
        },
        tooltip: {
          backgroundColor: '#1a1318',
          borderColor: '#2a1f22',
          borderWidth: 1,
          titleColor: '#e8ddd5',
          bodyColor: '#e8ddd5',
          callbacks: {
            label: ctx2 => `${ctx2.dataset.label}: ${ctx2.raw != null ? ctx2.raw + 'ìœ„' : 'â€”'}`
          }
        }
      }
    }
  });

  // ëª¨ë‹¬ ì—´ê¸°
  document.getElementById('country-modal').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function setModalStat(valId, diffId, curr, prev) {
  const el     = document.getElementById(valId);
  const diffEl = document.getElementById(diffId);
  el.textContent = curr != null ? `${curr}ìœ„` : 'â€”';
  if (diffEl) {
    if (curr != null && prev != null) {
      const d = prev - curr;
      if (d > 0)      { diffEl.textContent = `â–² ${d} ìƒìŠ¹`; diffEl.className = 'modal-stat-diff up'; }
      else if (d < 0) { diffEl.textContent = `â–¼ ${Math.abs(d)} í•˜ë½`; diffEl.className = 'modal-stat-diff down'; }
      else            { diffEl.textContent = 'ë³€ë™ ì—†ìŒ'; diffEl.className = 'modal-stat-diff'; }
    } else {
      diffEl.textContent = ''; diffEl.className = 'modal-stat-diff';
    }
  }
}

function closeModal(e) {
  if (e.target === document.getElementById('country-modal')) closeModalDirect();
}

function closeModalDirect() {
  document.getElementById('country-modal').classList.remove('open');
  document.body.style.overflow = '';
}

// ESC í‚¤ë¡œ ë‹«ê¸°
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModalDirect(); });

// â”€â”€â”€ ìë™ ê°±ì‹  (30ë¶„) â”€â”€â”€
setInterval(() => { loadData(); loadSteamData(); loadTrendsData(); }, 30 * 60 * 1000);

// â”€â”€â”€ ì´ˆê¸° ì‹¤í–‰ â”€â”€â”€
// â”€â”€â”€ ì¶œì‹œ ì¹´ìš´íŠ¸ë‹¤ìš´ â”€â”€â”€
const RELEASE_TIMES = [
  { flag: 'ğŸ‡°ğŸ‡·', country: 'í•œêµ­', iso: '2026-03-20T07:00:00+09:00', localLabel: '3/20 07:00 KST' },
  { flag: 'ğŸ‡¯ğŸ‡µ', country: 'ì¼ë³¸', iso: '2026-03-20T07:00:00+09:00', localLabel: '3/20 07:00 JST' },
  { flag: 'ğŸ‡ºğŸ‡¸', country: 'ë¯¸êµ­', iso: '2026-03-19T15:00:00-07:00', localLabel: '3/19 15:00 PT'  },
  { flag: 'ğŸ‡¬ğŸ‡§', country: 'ì˜êµ­', iso: '2026-03-19T22:00:00+00:00', localLabel: '3/19 22:00 GMT' },
  { flag: 'ğŸ‡©ğŸ‡ª', country: 'ë…ì¼', iso: '2026-03-19T23:00:00+01:00', localLabel: '3/19 23:00 CET' },
];

function pad2(n) { return String(n).padStart(2, '0'); }

function renderCountdown() {
  const grid = document.getElementById('countdown-grid');
  if (!grid) return;
  const now = Date.now();

  grid.innerHTML = RELEASE_TIMES.map(r => {
    const target = new Date(r.iso).getTime();
    const diff = target - now;
    const released = diff <= 0;
    const localStr = r.localLabel;

    if (released) {
      return `
        <div class="countdown-card released" id="cd-${r.country}">
          <div class="countdown-flag">${r.flag}</div>
          <div class="countdown-country">${r.country}</div>
          <div class="countdown-released-badge">âœ… ì¶œì‹œë¨</div>
          <div class="countdown-localtime">${localStr}</div>
        </div>`;
    }

    const days  = Math.floor(diff / 86400000);
    const hours = Math.floor((diff % 86400000) / 3600000);
    const mins  = Math.floor((diff % 3600000) / 60000);
    const secs  = Math.floor((diff % 60000) / 1000);

    return `
      <div class="countdown-card" id="cd-${r.country}">
        <div class="countdown-flag">${r.flag}</div>
        <div class="countdown-country">${r.country}</div>
        <div class="countdown-digits">
          <div class="cd-unit"><div class="cd-num">${pad2(days)}</div><div class="cd-label">ì¼</div></div>
          <div class="cd-sep">:</div>
          <div class="cd-unit"><div class="cd-num">${pad2(hours)}</div><div class="cd-label">ì‹œ</div></div>
          <div class="cd-sep">:</div>
          <div class="cd-unit"><div class="cd-num">${pad2(mins)}</div><div class="cd-label">ë¶„</div></div>
          <div class="cd-sep">:</div>
          <div class="cd-unit"><div class="cd-num">${pad2(secs)}</div><div class="cd-label">ì´ˆ</div></div>
        </div>
        <div class="countdown-localtime">${localStr} ì¶œì‹œ</div>
      </div>`;
  }).join('');
}

renderCountdown();
setInterval(renderCountdown, 1000);

initEvPanels();
loadData().then(() => renderSalesEstimate());
loadSteamData();
loadTrendsData();
</script>
</body>
</html>
