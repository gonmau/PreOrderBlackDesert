<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crimson Desert â€” PS Store Global Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0a0608;
      --surface: #110d0f;
      --surface2: #1a1318;
      --border: #2a1f22;
      --red: #c0392b;
      --red-glow: #e74c3c;
      --gold: #d4a017;
      --text: #e8ddd5;
      --muted: #7a6a65;
      --up: #2ecc71;
      --down: #e74c3c;
      --same: #5a5a5a;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ë°°ê²½ í…ìŠ¤ì²˜ */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse 80% 40% at 50% -10%, rgba(192,57,43,0.12) 0%, transparent 70%),
        url("data:image/svg+xml,%3Csvg width='60' height='60' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 0;
    }

    .container { position: relative; z-index: 1; max-width: 1400px; margin: 0 auto; padding: 0 24px 60px; }

    /* â”€â”€â”€ HEADER â”€â”€â”€ */
    header {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 48px 24px 32px;
      border-bottom: 1px solid var(--border);
      position: relative;
    }

    .logo-line {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 4px;
    }

    .logo-icon {
      width: 44px;
      height: 44px;
      background: var(--red);
      clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
      animation: pulse-icon 3s ease-in-out infinite;
    }

    @keyframes pulse-icon {
      0%, 100% { box-shadow: 0 0 0 0 rgba(192,57,43,0.4); }
      50% { box-shadow: 0 0 20px 6px rgba(192,57,43,0.2); }
    }

    h1 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: clamp(2rem, 5vw, 3.5rem);
      letter-spacing: 4px;
      color: var(--text);
      line-height: 1;
    }

    h1 span { color: var(--red-glow); }

    .subtitle {
      font-size: 0.75rem;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--muted);
      margin-top: 6px;
    }

    .meta-row {
      display: flex;
      gap: 24px;
      margin-top: 16px;
      font-size: 0.78rem;
      color: var(--muted);
      flex-wrap: wrap;
      justify-content: center;
    }

    .meta-row strong { color: var(--text); }

    /* â”€â”€â”€ HERO STATS â”€â”€â”€ */
    .hero-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1px;
      margin: 32px 0;
      border: 1px solid var(--border);
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
    }

    .stat-box {
      background: var(--surface);
      padding: 24px 20px;
      text-align: center;
      transition: background 0.2s;
    }

    .stat-box:hover { background: var(--surface2); }

    .stat-label {
      font-size: 0.65rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .stat-value {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 2.4rem;
      line-height: 1;
      color: var(--red-glow);
    }

    .stat-value.gold { color: var(--gold); }
    .stat-value.neutral { color: var(--text); }

    .stat-diff {
      font-size: 0.75rem;
      margin-top: 4px;
      color: var(--muted);
    }

    .stat-diff.up { color: var(--up); }
    .stat-diff.down { color: var(--down); }

    /* â”€â”€â”€ CHART â”€â”€â”€ */
    .chart-section {
      margin-bottom: 32px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 24px;
    }

    .section-title {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.2rem;
      letter-spacing: 3px;
      color: var(--muted);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    .chart-wrapper { position: relative; height: 220px; }

    /* â”€â”€â”€ REGION TABS â”€â”€â”€ */
    .tabs {
      display: flex;
      gap: 0;
      margin-bottom: 0;
      border: 1px solid var(--border);
      border-bottom: none;
      border-radius: 4px 4px 0 0;
      overflow: hidden;
    }

    .tab-btn {
      flex: 1;
      padding: 12px 8px;
      background: var(--surface);
      border: none;
      color: var(--muted);
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1rem;
      letter-spacing: 2px;
      cursor: pointer;
      transition: all 0.2s;
      border-right: 1px solid var(--border);
    }

    .tab-btn:last-child { border-right: none; }
    .tab-btn:hover { background: var(--surface2); color: var(--text); }
    .tab-btn.active { background: var(--red); color: #fff; }

    /* â”€â”€â”€ COUNTRY TABLE â”€â”€â”€ */
    .table-wrap {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 0 0 4px 4px;
      overflow: hidden;
      margin-bottom: 32px;
    }

    table { width: 100%; border-collapse: collapse; }

    thead tr {
      background: var(--surface2);
      border-bottom: 1px solid var(--border);
    }

    th {
      padding: 10px 16px;
      font-size: 0.65rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--muted);
      text-align: left;
      font-weight: 400;
    }

    th:not(:first-child) { text-align: center; }

    tbody tr {
      border-bottom: 1px solid var(--border);
      transition: background 0.15s;
    }

    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: var(--surface2); }

    td {
      padding: 12px 16px;
      font-size: 0.85rem;
    }

    td:not(:first-child) { text-align: center; }

    .country-cell {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .flag { font-size: 1.2rem; }

    .country-name { font-weight: 700; }

    .weight-badge {
      font-size: 0.65rem;
      color: var(--muted);
      background: var(--surface2);
      padding: 2px 6px;
      border-radius: 2px;
    }

    .rank-val { font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; }

    .rank-val.no-data { color: var(--muted); font-size: 0.8rem; }

    .diff-badge {
      display: inline-flex;
      align-items: center;
      gap: 2px;
      font-size: 0.7rem;
      padding: 2px 5px;
      border-radius: 2px;
      margin-left: 4px;
    }

    .diff-badge.up { color: var(--up); background: rgba(46,204,113,0.1); }
    .diff-badge.down { color: var(--down); background: rgba(231,76,60,0.1); }
    .diff-badge.same { color: var(--same); }

    .combined-cell { font-weight: 700; }

    /* â”€â”€â”€ HEATMAP â”€â”€â”€ */
    .heatmap-section {
      margin-bottom: 32px;
    }

    .heatmap-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 6px;
    }

    .heatmap-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 3px;
      padding: 10px 12px;
      cursor: default;
      transition: transform 0.15s;
      position: relative;
      overflow: hidden;
    }

    .heatmap-card:hover { transform: scale(1.03); }

    .heatmap-card::before {
      content: '';
      position: absolute;
      left: 0; top: 0; bottom: 0;
      width: 3px;
    }

    .heatmap-card .hm-flag { font-size: 1.4rem; line-height: 1; }
    .heatmap-card .hm-country {
      font-size: 0.78rem;
      color: var(--text);
      font-weight: 700;
      margin: 4px 0 2px;
      letter-spacing: 0.3px;
      text-shadow: 0 1px 3px rgba(0,0,0,0.8);
    }
    .heatmap-card .hm-rank {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.5rem;
      line-height: 1;
    }

    /* â”€â”€â”€ FOOTER â”€â”€â”€ */
    footer {
      text-align: center;
      padding: 24px;
      font-size: 0.72rem;
      color: var(--muted);
      border-top: 1px solid var(--border);
      letter-spacing: 1px;
    }

    /* â”€â”€â”€ LOADING / ERROR â”€â”€â”€ */
    #loading-screen {
      position: fixed;
      inset: 0;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
      transition: opacity 0.5s;
    }

    .loader-title {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 2rem;
      letter-spacing: 6px;
      color: var(--red-glow);
      margin-bottom: 20px;
    }

    .loader-bar {
      width: 200px;
      height: 2px;
      background: var(--border);
      border-radius: 1px;
      overflow: hidden;
    }

    .loader-fill {
      height: 100%;
      background: var(--red-glow);
      animation: load-anim 1.5s ease-in-out infinite;
    }

    @keyframes load-anim {
      0% { width: 0%; margin-left: 0; }
      50% { width: 60%; margin-left: 20%; }
      100% { width: 0%; margin-left: 100%; }
    }

    .fade-in { animation: fadeIn 0.5s ease forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }

    .row-enter { animation: rowEnter 0.3s ease forwards; }
    @keyframes rowEnter { from { opacity: 0; } to { opacity: 1; } }

    /* ë°˜ì‘í˜• */
    @media (max-width: 640px) {
      .hero-stats { grid-template-columns: repeat(2, 1fr); }
      .tabs { font-size: 0.8rem; }
      th, td { padding: 8px 10px; }
      .weight-badge { display: none; }
    }
  </style>
</head>
<body>

<div id="loading-screen">
  <div class="loader-title">LOADING DATA</div>
  <div class="loader-bar"><div class="loader-fill"></div></div>
</div>

<div id="app" style="opacity:0">
  <header>
    <div class="logo-line">
      <div class="logo-icon">âš”ï¸</div>
      <h1>CRIMSON <span>DESERT</span></h1>
    </div>
    <div class="subtitle">PlayStation Store â€” Global Pre-order Rank Tracker</div>
    <div class="meta-row">
      <span>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <strong id="last-updated">â€”</strong></span>
      <span>ì¶”ì  êµ­ê°€: <strong id="country-count">â€”</strong>ê°œêµ­</span>
      <span>íˆìŠ¤í† ë¦¬: <strong id="history-count">â€”</strong>íšŒ</span>
    </div>
  </header>

  <div class="container">
    <!-- HERO STATS -->
    <div class="hero-stats fade-in" id="hero-stats">
      <div class="stat-box">
        <div class="stat-label">ì „ì²´ ê°€ì¤‘ í‰ê·  ìˆœìœ„</div>
        <div class="stat-value" id="stat-combined">â€”</div>
        <div class="stat-diff" id="stat-combined-diff"></div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Americas í‰ê· </div>
        <div class="stat-value gold" id="stat-americas">â€”</div>
        <div class="stat-diff" id="stat-americas-diff"></div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Europe & ME í‰ê· </div>
        <div class="stat-value neutral" id="stat-europe">â€”</div>
        <div class="stat-diff" id="stat-europe-diff"></div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Asia & Oceania í‰ê· </div>
        <div class="stat-value" id="stat-asia">â€”</div>
        <div class="stat-diff" id="stat-asia-diff"></div>
      </div>
      <div class="stat-box">
        <div class="stat-label">ìµœê³  ìˆœìœ„ êµ­ê°€</div>
        <div class="stat-value gold" id="stat-best-flag" style="font-size:2rem">â€”</div>
        <div class="stat-diff" id="stat-best-name"></div>
      </div>
    </div>

    <!-- CHART -->
    <div class="chart-section fade-in">
      <div class="section-title">ìˆœìœ„ íˆìŠ¤í† ë¦¬ (ê°€ì¤‘ í‰ê· )</div>
      <div class="chart-wrapper">
        <canvas id="rankChart"></canvas>
      </div>
    </div>

    <!-- HEATMAP -->
    <div class="heatmap-section fade-in">
      <div class="section-title">ì „ì„¸ê³„ í˜„í™© í•œëˆˆì—</div>
      <div class="heatmap-grid" id="heatmap-grid"></div>
    </div>

    <!-- TABLE -->
    <div class="fade-in">
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('all', this)">ALL</button>
        <button class="tab-btn" onclick="switchTab('americas', this)">Americas</button>
        <button class="tab-btn" onclick="switchTab('europe', this)">Europe & ME</button>
        <button class="tab-btn" onclick="switchTab('asia', this)">Asia & Oceania</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>êµ­ê°€</th>
              <th>ìŠ¤íƒ ë‹¤ë“œ</th>
              <th>ë””ëŸ­ìŠ¤</th>
              <th>ì¢…í•© (Best)</th>
              <th>ê°€ì¤‘ì¹˜</th>
            </tr>
          </thead>
          <tbody id="rank-table"></tbody>
        </table>
      </div>
    </div>
  </div>

  <footer>
    CRIMSON DESERT PS STORE TRACKER &nbsp;Â·&nbsp; DATA UPDATES VIA GITHUB ACTIONS &nbsp;Â·&nbsp; AUTO-REFRESHES EVERY 30 MIN
  </footer>
</div>

<script>
// â”€â”€â”€ ë°ì´í„° ì„¤ì • â”€â”€â”€
const REGIONS = {
  "Americas": ["ë¯¸êµ­","ìºë‚˜ë‹¤","ë¸Œë¼ì§ˆ","ë©•ì‹œì½”","ì•„ë¥´í—¨í‹°ë‚˜","ì¹ ë ˆ","ì½œë¡¬ë¹„ì•„","í˜ë£¨","ìš°ë£¨ê³¼ì´","ë³¼ë¦¬ë¹„ì•„","ê³¼í…Œë§ë¼","ì˜¨ë‘ë¼ìŠ¤"],
  "Europe & Middle East": ["ì˜êµ­","ë…ì¼","í”„ë‘ìŠ¤","ìŠ¤í˜ì¸","ì´íƒˆë¦¬ì•„","ë„¤ëœë€ë“œ","í´ë€ë“œ","ìŠ¤ìœ„ìŠ¤","ìŠ¤ì›¨ë´","ë…¸ë¥´ì›¨ì´","ë´ë§ˆí¬","í•€ë€ë“œ","í¬ë¥´íˆ¬ê°ˆ","ê·¸ë¦¬ìŠ¤","ì²´ì½”","í—ê°€ë¦¬","ë£¨ë§ˆë‹ˆì•„","ìŠ¬ë¡œë°”í‚¤ì•„","ìŠ¬ë¡œë² ë‹ˆì•„","ìš°í¬ë¼ì´ë‚˜","ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„","ì•„ëì—ë¯¸ë¦¬íŠ¸","ë‚¨ì•„ê³µ"],
  "Asia & Oceania": ["ì¼ë³¸","í•œêµ­","ì¤‘êµ­","í˜¸ì£¼","ì¸ë„","íƒœêµ­","ì‹±ê°€í¬ë¥´","ë§ë ˆì´ì‹œì•„","ì¸ë„ë„¤ì‹œì•„","í•„ë¦¬í•€","ë² íŠ¸ë‚¨","í™ì½©","ëŒ€ë§Œ","ë‰´ì§ˆëœë“œ"]
};

const MARKET_WEIGHTS = {
  "ë¯¸êµ­":30.0,"ìºë‚˜ë‹¤":4.5,"ë¸Œë¼ì§ˆ":2.5,"ë©•ì‹œì½”":2.0,"ì•„ë¥´í—¨í‹°ë‚˜":0.9,"ì¹ ë ˆ":0.8,"ì½œë¡¬ë¹„ì•„":0.7,"í˜ë£¨":0.4,"ìš°ë£¨ê³¼ì´":0.3,"ë³¼ë¦¬ë¹„ì•„":0.2,"ê³¼í…Œë§ë¼":0.2,"ì˜¨ë‘ë¼ìŠ¤":0.2,
  "ì˜êµ­":8.5,"ë…ì¼":6.5,"í”„ë‘ìŠ¤":6.0,"ìŠ¤í˜ì¸":4.0,"ì´íƒˆë¦¬ì•„":3.5,"ë„¤ëœë€ë“œ":1.8,"ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„":1.5,"ì•„ëì—ë¯¸ë¦¬íŠ¸":1.2,"í´ë€ë“œ":1.2,"ìŠ¤ìœ„ìŠ¤":1.0,"ìŠ¤ì›¨ë´":1.0,"ë´ë§ˆí¬":0.9,"í¬ë¥´íˆ¬ê°ˆ":0.8,"í•€ë€ë“œ":0.8,"ë…¸ë¥´ì›¨ì´":0.8,"ë‚¨ì•„ê³µ":0.8,"ì²´ì½”":0.7,"ë£¨ë§ˆë‹ˆì•„":0.6,"ê·¸ë¦¬ìŠ¤":0.5,"í—ê°€ë¦¬":0.5,"ìš°í¬ë¼ì´ë‚˜":0.5,"ìŠ¬ë¡œë°”í‚¤ì•„":0.3,"ìŠ¬ë¡œë² ë‹ˆì•„":0.3,
  "ì¼ë³¸":8.0,"í˜¸ì£¼":3.0,"í•œêµ­":2.8,"ì¸ë„":2.0,"ëŒ€ë§Œ":1.0,"ì‹±ê°€í¬ë¥´":0.8,"íƒœêµ­":0.9,"í™ì½©":0.9,"ì¸ë„ë„¤ì‹œì•„":0.8,"ë§ë ˆì´ì‹œì•„":0.7,"ë² íŠ¸ë‚¨":0.7,"í•„ë¦¬í•€":0.6,"ë‰´ì§ˆëœë“œ":0.6,"ì¤‘êµ­":0.2
};

const FLAGS = {
  "ë¯¸êµ­":"ğŸ‡ºğŸ‡¸","ìºë‚˜ë‹¤":"ğŸ‡¨ğŸ‡¦","ë¸Œë¼ì§ˆ":"ğŸ‡§ğŸ‡·","ë©•ì‹œì½”":"ğŸ‡²ğŸ‡½","ì•„ë¥´í—¨í‹°ë‚˜":"ğŸ‡¦ğŸ‡·","ì¹ ë ˆ":"ğŸ‡¨ğŸ‡±","ì½œë¡¬ë¹„ì•„":"ğŸ‡¨ğŸ‡´","í˜ë£¨":"ğŸ‡µğŸ‡ª","ìš°ë£¨ê³¼ì´":"ğŸ‡ºğŸ‡¾","ë³¼ë¦¬ë¹„ì•„":"ğŸ‡§ğŸ‡´","ê³¼í…Œë§ë¼":"ğŸ‡¬ğŸ‡¹","ì˜¨ë‘ë¼ìŠ¤":"ğŸ‡­ğŸ‡³",
  "ì˜êµ­":"ğŸ‡¬ğŸ‡§","ë…ì¼":"ğŸ‡©ğŸ‡ª","í”„ë‘ìŠ¤":"ğŸ‡«ğŸ‡·","ìŠ¤í˜ì¸":"ğŸ‡ªğŸ‡¸","ì´íƒˆë¦¬ì•„":"ğŸ‡®ğŸ‡¹","ë„¤ëœë€ë“œ":"ğŸ‡³ğŸ‡±","í´ë€ë“œ":"ğŸ‡µğŸ‡±","ìŠ¤ìœ„ìŠ¤":"ğŸ‡¨ğŸ‡­","ìŠ¤ì›¨ë´":"ğŸ‡¸ğŸ‡ª","ë…¸ë¥´ì›¨ì´":"ğŸ‡³ğŸ‡´","ë´ë§ˆí¬":"ğŸ‡©ğŸ‡°","í•€ë€ë“œ":"ğŸ‡«ğŸ‡®","í¬ë¥´íˆ¬ê°ˆ":"ğŸ‡µğŸ‡¹","ê·¸ë¦¬ìŠ¤":"ğŸ‡¬ğŸ‡·","ì²´ì½”":"ğŸ‡¨ğŸ‡¿","í—ê°€ë¦¬":"ğŸ‡­ğŸ‡º","ë£¨ë§ˆë‹ˆì•„":"ğŸ‡·ğŸ‡´","ìŠ¬ë¡œë°”í‚¤ì•„":"ğŸ‡¸ğŸ‡°","ìŠ¬ë¡œë² ë‹ˆì•„":"ğŸ‡¸ğŸ‡®","ìš°í¬ë¼ì´ë‚˜":"ğŸ‡ºğŸ‡¦","ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„":"ğŸ‡¸ğŸ‡¦","ì•„ëì—ë¯¸ë¦¬íŠ¸":"ğŸ‡¦ğŸ‡ª","ë‚¨ì•„ê³µ":"ğŸ‡¿ğŸ‡¦",
  "ì¼ë³¸":"ğŸ‡¯ğŸ‡µ","í•œêµ­":"ğŸ‡°ğŸ‡·","ì¤‘êµ­":"ğŸ‡¨ğŸ‡³","í˜¸ì£¼":"ğŸ‡¦ğŸ‡º","ì¸ë„":"ğŸ‡®ğŸ‡³","íƒœêµ­":"ğŸ‡¹ğŸ‡­","ì‹±ê°€í¬ë¥´":"ğŸ‡¸ğŸ‡¬","ë§ë ˆì´ì‹œì•„":"ğŸ‡²ğŸ‡¾","ì¸ë„ë„¤ì‹œì•„":"ğŸ‡®ğŸ‡©","í•„ë¦¬í•€":"ğŸ‡µğŸ‡­","ë² íŠ¸ë‚¨":"ğŸ‡»ğŸ‡³","í™ì½©":"ğŸ‡­ğŸ‡°","ëŒ€ë§Œ":"ğŸ‡¹ğŸ‡¼","ë‰´ì§ˆëœë“œ":"ğŸ‡³ğŸ‡¿"
};

const URLS = {
  "ë¯¸êµ­":"https://store.playstation.com/en-us/category/3bf499d7-7acf-4931-97dd-2667494ee2c9/1",
  "ìºë‚˜ë‹¤":"https://store.playstation.com/en-ca/category/3bf499d7-7acf-4931-97dd-2667494ee2c9/1",
  "ì˜êµ­":"https://store.playstation.com/en-gb/category/3bf499d7-7acf-4931-97dd-2667494ee2c9/1",
  "ë…ì¼":"https://store.playstation.com/de-de/category/3bf499d7-7acf-4931-97dd-2667494ee2c9/1",
  "ì¼ë³¸":"https://store.playstation.com/ja-jp/category/3bf499d7-7acf-4931-97dd-2667494ee2c9/1",
  "í•œêµ­":"https://store.playstation.com/ko-kr/category/3bf499d7-7acf-4931-97dd-2667494ee2c9/1",
};

// â”€â”€â”€ ìœ í‹¸ í•¨ìˆ˜ â”€â”€â”€
function combinedRank(s, d) {
  if (s && d) return Math.min(s, d);
  return s || d || null;
}

function calcAvg(rawResults, countries) {
  let sum = 0, w = 0;
  const list = countries || Object.keys(rawResults);
  list.forEach(c => {
    if (!rawResults[c]) return;
    const cr = combinedRank(rawResults[c].standard, rawResults[c].deluxe);
    const wt = MARKET_WEIGHTS[c] || 1;
    if (cr) { sum += cr * wt; w += wt; }
  });
  return w > 0 ? sum / w : null;
}

function diffBadge(curr, prev) {
  if (curr == null || prev == null) return '';
  const d = prev - curr; // ì‘ì•„ì§€ë©´ ìƒìŠ¹
  if (d > 0) return `<span class="diff-badge up">â–²${d}</span>`;
  if (d < 0) return `<span class="diff-badge down">â–¼${Math.abs(d)}</span>`;
  return `<span class="diff-badge same">â€”</span>`;
}

function rankColor(rank) {
  if (rank == null) return '#2a1f22';
  if (rank <= 5)  return 'rgba(212,160,23,0.6)';
  if (rank <= 10) return 'rgba(192,57,43,0.5)';
  if (rank <= 20) return 'rgba(192,57,43,0.25)';
  if (rank <= 40) return 'rgba(192,57,43,0.1)';
  return 'rgba(50,40,45,0.5)';
}

function getRegion(country) {
  for (const [r, cs] of Object.entries(REGIONS)) {
    if (cs.includes(country)) return r;
  }
  return null;
}

// â”€â”€â”€ ì „ì—­ ìƒíƒœ â”€â”€â”€
let allHistory = [];
let currentTab = 'all';
let chartInstance = null;

// â”€â”€â”€ ë©”ì¸ ë¡œì§ â”€â”€â”€
async function loadData() {
  try {
    const res = await fetch('rank_history.json?t=' + Date.now());
    if (!res.ok) throw new Error('fetch failed');
    allHistory = await res.json();
  } catch (e) {
    // ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ í‘œì‹œ
    document.getElementById('loading-screen').style.opacity = 0;
    setTimeout(() => document.getElementById('loading-screen').style.display = 'none', 500);
    document.getElementById('app').style.opacity = 1;
    document.getElementById('last-updated').textContent = 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ â€” rank_history.json í™•ì¸';
    return;
  }

  render();

  // ë¡œë”© ìˆ¨ê¸°ê¸°
  const ls = document.getElementById('loading-screen');
  ls.style.opacity = 0;
  setTimeout(() => ls.style.display = 'none', 500);
  const app = document.getElementById('app');
  app.style.transition = 'opacity 0.5s';
  app.style.opacity = 1;
}

function render() {
  if (!allHistory.length) return;

  const latest = allHistory[allHistory.length - 1];
  const prev   = allHistory.length >= 2 ? allHistory[allHistory.length - 2] : null;
  const raw    = latest.raw_results;

  // ë©”íƒ€ ì •ë³´
  const dt = new Date(latest.timestamp);
  document.getElementById('last-updated').textContent = dt.toLocaleString('ko-KR');
  document.getElementById('country-count').textContent = Object.keys(raw).length;
  document.getElementById('history-count').textContent = allHistory.length;

  // HERO STATS
  const combinedAvg = calcAvg(raw, null);
  const prevCombinedAvg = prev ? calcAvg(prev.raw_results, null) : null;
  setHeroStat('stat-combined', 'stat-combined-diff', combinedAvg, prevCombinedAvg, 'ìœ„');

  for (const [regionKey, regionName] of [['americas','Americas'],['europe','Europe & Middle East'],['asia','Asia & Oceania']]) {
    const countries = REGIONS[regionName];
    const avg = calcAvg(raw, countries);
    const prevAvg = prev ? calcAvg(prev.raw_results, countries) : null;
    setHeroStat(`stat-${regionKey}`, `stat-${regionKey}-diff`, avg, prevAvg, 'ìœ„');
  }

  // ìµœê³  ìˆœìœ„ êµ­ê°€
  let bestCountry = null, bestRank = Infinity;
  Object.entries(raw).forEach(([c, d]) => {
    const cr = combinedRank(d.standard, d.deluxe);
    if (cr && cr < bestRank) { bestRank = cr; bestCountry = c; }
  });
  if (bestCountry) {
    document.getElementById('stat-best-flag').textContent = FLAGS[bestCountry] || '?';
    document.getElementById('stat-best-name').textContent = `${bestCountry} Â· ${bestRank}ìœ„`;
  }

  // CHART
  renderChart();

  // HEATMAP
  renderHeatmap(raw, prev?.raw_results);

  // TABLE
  renderTable(currentTab, raw, prev?.raw_results);
}

function setHeroStat(valId, diffId, curr, prev, suffix='') {
  const el = document.getElementById(valId);
  const diffEl = document.getElementById(diffId);
  el.textContent = curr ? `${curr.toFixed(1)}${suffix}` : 'â€”';
  if (diffEl && curr && prev) {
    const d = prev - curr; // ì‘ì„ìˆ˜ë¡ ì¢‹ìœ¼ë‹ˆê¹Œ prev > currì´ë©´ ìƒìŠ¹
    if (d > 0) { diffEl.textContent = `â–² ${d.toFixed(1)} ìƒìŠ¹`; diffEl.className = 'stat-diff up'; }
    else if (d < 0) { diffEl.textContent = `â–¼ ${Math.abs(d).toFixed(1)} í•˜ë½`; diffEl.className = 'stat-diff down'; }
    else { diffEl.textContent = 'ë³€ë™ ì—†ìŒ'; diffEl.className = 'stat-diff'; }
  }
}

function renderChart() {
  const labels = allHistory.map(h => {
    const d = new Date(h.timestamp);
    return `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  });
  const dataPoints = allHistory.map(h => h.averages?.combined ?? null);

  const ctx = document.getElementById('rankChart').getContext('2d');
  if (chartInstance) chartInstance.destroy();

  chartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'ê°€ì¤‘ í‰ê·  ìˆœìœ„',
        data: dataPoints,
        borderColor: '#c0392b',
        backgroundColor: (ctx2) => {
          const g = ctx2.chart.ctx.createLinearGradient(0, 0, 0, 220);
          g.addColorStop(0, 'rgba(192,57,43,0.25)');
          g.addColorStop(1, 'rgba(192,57,43,0)');
          return g;
        },
        borderWidth: 2,
        pointBackgroundColor: '#e74c3c',
        pointRadius: dataPoints.length > 30 ? 0 : 4,
        pointHoverRadius: 6,
        tension: 0.4,
        fill: true,
        spanGaps: true,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          reverse: true, // ìˆœìœ„ ë‚®ì„ìˆ˜ë¡ ìœ„
          ticks: { color: '#7a6a65', font: { size: 11 } },
          grid: { color: 'rgba(42,31,34,0.8)' },
          border: { color: '#2a1f22' }
        },
        x: {
          ticks: {
            color: '#7a6a65',
            font: { size: 10 },
            maxTicksLimit: 12,
            maxRotation: 0
          },
          grid: { display: false },
          border: { color: '#2a1f22' }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#1a1318',
          borderColor: '#2a1f22',
          borderWidth: 1,
          titleColor: '#e8ddd5',
          bodyColor: '#c0392b',
          callbacks: {
            label: ctx2 => `ê°€ì¤‘ í‰ê· : ${ctx2.raw?.toFixed(1) ?? 'â€”'}ìœ„`
          }
        }
      }
    }
  });
}

function renderHeatmap(raw, prevRaw) {
  const grid = document.getElementById('heatmap-grid');
  const allCountries = Object.values(REGIONS).flat();
  
  // ìˆœìœ„ ê¸°ì¤€ ì •ë ¬ (ìˆœìœ„ ì—†ëŠ” ê±´ ë’¤ë¡œ)
  const sorted = allCountries.slice().sort((a, b) => {
    const ra = combinedRank(raw[a]?.standard, raw[a]?.deluxe) ?? 9999;
    const rb = combinedRank(raw[b]?.standard, raw[b]?.deluxe) ?? 9999;
    return ra - rb;
  });

  grid.innerHTML = sorted.map(c => {
    const d = raw[c] || {};
    const cr = combinedRank(d.standard, d.deluxe);
    const prevCr = prevRaw ? combinedRank(prevRaw[c]?.standard, prevRaw[c]?.deluxe) : null;
    const diff = cr && prevCr ? prevCr - cr : 0;
    const arrowColor = diff > 0 ? '#2ecc71' : diff < 0 ? '#e74c3c' : 'transparent';
    const bgColor = rankColor(cr);

    return `
      <div class="heatmap-card" style="background:${bgColor}" title="${c}: S${d.standard ?? '-'} / D${d.deluxe ?? '-'}">
        <div style="position:absolute;left:0;top:0;bottom:0;width:3px;background:${arrowColor}"></div>
        <div style="display:flex;align-items:center;gap:5px;margin-bottom:4px">
          <span class="hm-flag">${FLAGS[c] || ''}</span>
          <span class="hm-country">${c}</span>
        </div>
        <div class="hm-rank" style="color:${cr && cr <= 10 ? '#d4a017' : '#e8ddd5'}">${cr ? `${cr}ìœ„` : 'â€”'}</div>
      </div>`;
  }).join('');
}

function renderTable(tab, raw, prevRaw) {
  const tbody = document.getElementById('rank-table');

  let countries;
  if (tab === 'all') {
    countries = Object.values(REGIONS).flat();
  } else if (tab === 'americas') {
    countries = REGIONS['Americas'];
  } else if (tab === 'europe') {
    countries = REGIONS['Europe & Middle East'];
  } else {
    countries = REGIONS['Asia & Oceania'];
  }

  // ê°€ì¤‘ì¹˜ ìˆœ ì •ë ¬
  const sorted = countries.slice().sort((a, b) => (MARKET_WEIGHTS[b] || 0) - (MARKET_WEIGHTS[a] || 0));

  tbody.innerHTML = sorted.map((c, i) => {
    const d = raw[c] || {};
    const pd = prevRaw?.[c] || {};
    const cr = combinedRank(d.standard, d.deluxe);
    const prevCr = combinedRank(pd.standard, pd.deluxe);
    const url = URLS[c];
    const nameLink = url
      ? `<a href="${url}" target="_blank" style="color:var(--text);text-decoration:none">${c}</a>`
      : c;

    return `
      <tr class="row-enter" style="animation-delay:${i * 0.02}s">
        <td>
          <div class="country-cell">
            <span class="flag">${FLAGS[c] || ''}</span>
            <span class="country-name">${nameLink}</span>
          </div>
        </td>
        <td>
          <span class="rank-val ${d.standard ? '' : 'no-data'}">${d.standard ? `${d.standard}ìœ„` : 'â€”'}</span>
          ${diffBadge(d.standard, pd.standard)}
        </td>
        <td>
          <span class="rank-val ${d.deluxe ? '' : 'no-data'}">${d.deluxe ? `${d.deluxe}ìœ„` : 'â€”'}</span>
          ${diffBadge(d.deluxe, pd.deluxe)}
        </td>
        <td class="combined-cell">
          <span class="rank-val ${cr ? '' : 'no-data'}" style="color:${cr && cr <= 10 ? 'var(--gold)' : 'var(--text)'}">${cr ? `${cr}ìœ„` : 'â€”'}</span>
          ${diffBadge(cr, prevCr)}
        </td>
        <td><span class="weight-badge">${(MARKET_WEIGHTS[c] || 0).toFixed(1)}</span></td>
      </tr>`;
  }).join('');
}

function switchTab(tab, btn) {
  currentTab = tab;
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  if (allHistory.length) {
    const latest = allHistory[allHistory.length - 1];
    const prev   = allHistory.length >= 2 ? allHistory[allHistory.length - 2] : null;
    renderTable(tab, latest.raw_results, prev?.raw_results);
  }
}

// â”€â”€â”€ ìë™ ê°±ì‹  (30ë¶„) â”€â”€â”€
setInterval(() => { loadData(); }, 30 * 60 * 1000);

// â”€â”€â”€ ì´ˆê¸° ì‹¤í–‰ â”€â”€â”€
loadData();
</script>
</body>
</html>
