<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Crimson Desert Rank Tracker</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    background:#0d0d0d;
    color:white;
    font-family: Arial, sans-serif;
}

h2 {
    margin-top:40px;
}

.section-title {
    font-size:22px;
    margin:30px 0 15px 0;
}

.country-grid {
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(120px,1fr));
    gap:10px;
}

.country-card {
    background:linear-gradient(145deg,#1a1a1a,#111);
    padding:12px;
    border-radius:8px;
    text-align:center;
    cursor:pointer;
    transition:0.2s;
    border:1px solid #222;
}

.country-card:hover {
    background:#222;
    transform:scale(1.05);
}

.country-name {
    font-weight:bold;
    font-size:15px;
    color:#ffffff;
    margin-bottom:5px;
}

.country-rank {
    font-size:18px;
    color:#ffb400;
}

canvas {
    background:#111;
    border-radius:10px;
    padding:10px;
}

.back-btn {
    margin-top:15px;
    padding:8px 12px;
    background:#ffb400;
    border:none;
    border-radius:6px;
    cursor:pointer;
    font-weight:bold;
}
</style>
</head>

<body>

<h2>ğŸ“Š ìˆœìœ„ íˆìŠ¤í† ë¦¬ (ê°€ì¤‘ í‰ê· )</h2>
<canvas id="rankChart"></canvas>
<button id="backBtn" class="back-btn" style="display:none;">ì „ì²´ í‰ê·  ë³´ê¸°</button>

<div class="section-title">ğŸŒ ì „ì„¸ê³„ í˜„í™© í•œëˆˆì—</div>
<div class="country-grid" id="countryGrid"></div>

<script>

let rankData;
let chart;
let currentView = "average";

const ctx = document.getElementById('rankChart').getContext('2d');

async function loadData() {
    const response = await fetch('rank_history.json');
    rankData = await response.json();

    drawAverageChart();
    drawCountryGrid();
}

function drawAverageChart() {

    const labels = rankData.map(r => r.timestamp);
    const avgRanks = rankData.map(r => r.weighted_average);

    if(chart) chart.destroy();

    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'ì „ì²´ í‰ê·  ìˆœìœ„',
                data: avgRanks,
                borderColor: '#ff3c3c',
                backgroundColor: 'rgba(255,60,60,0.2)',
                tension:0.3
            }]
        },
        options: {
            responsive:true,
            scales: {
                y: {
                    reverse:true
                }
            }
        }
    });

    currentView = "average";
    document.getElementById("backBtn").style.display = "none";
}

function drawCountryChart(countryCode) {

    const labels = rankData.map(r => r.timestamp);
    const countryRanks = rankData.map(r => r.ranks[countryCode] || null);

    if(chart) chart.destroy();

    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: countryCode + ' ìˆœìœ„ ë³€ë™',
                data: countryRanks,
                borderColor: '#00d4ff',
                backgroundColor: 'rgba(0,212,255,0.2)',
                tension:0.3
            }]
        },
        options: {
            responsive:true,
            scales: {
                y: {
                    reverse:true
                }
            }
        }
    });

    currentView = countryCode;
    document.getElementById("backBtn").style.display = "inline-block";
}

function getFlagEmoji(code) {
    return code
        .toUpperCase()
        .replace(/./g, char => 
            String.fromCodePoint(127397 + char.charCodeAt())
        );
}

function drawCountryGrid() {

    const latest = rankData[rankData.length - 1];
    const grid = document.getElementById('countryGrid');

    Object.entries(latest.ranks)
        .sort((a,b)=>a[1]-b[1])
        .forEach(([code, rank]) => {

            const card = document.createElement('div');
            card.className = "country-card";

            const flag = getFlagEmoji(code);

            card.innerHTML = `
                <div class="country-name">${flag} ${code}</div>
                <div class="country-rank">${rank}ìœ„</div>
            `;

            card.onclick = () => drawCountryChart(code);

            grid.appendChild(card);
        });
}

document.getElementById("backBtn").onclick = drawAverageChart;

loadData();

</script>

</body>
</html>
